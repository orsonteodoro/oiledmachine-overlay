diff -urp civetweb-1.13.orig/CMakeLists.txt civetweb-1.13/CMakeLists.txt
--- civetweb-1.13.orig/CMakeLists.txt	2020-11-27 22:35:00.935116162 -0800
+++ civetweb-1.13/CMakeLists.txt	2020-11-27 22:44:35.398043804 -0800
@@ -1,5 +1,5 @@
 # Determines what CMake APIs we can rely on
-cmake_minimum_required (VERSION 2.8.11)
+cmake_minimum_required (VERSION 3.3)
 if (${CMAKE_VERSION} VERSION_GREATER 3.2.2)
   cmake_policy(VERSION 3.2.2)
 endif()
@@ -7,6 +7,7 @@ if (${CMAKE_VERSION} VERSION_GREATER 3.1
     ${CMAKE_VERSION} VERSION_EQUAL 3.1)
   cmake_policy(SET CMP0054 NEW)
 endif()
+cmake_policy(SET CMP0060 NEW)
 
 # Set up the project
 project (civetweb)
diff -urp civetweb-1.13.orig/src/CMakeLists.txt civetweb-1.13/src/CMakeLists.txt
--- civetweb-1.13.orig/src/CMakeLists.txt	2020-09-30 11:24:15.000000000 -0700
+++ civetweb-1.13/src/CMakeLists.txt	2020-11-27 22:35:25.824065913 -0800
@@ -15,7 +15,8 @@ if (BUILD_SHARED_LIBS)
 endif()
 target_include_directories(
   civetweb-c-library PUBLIC
-  $<BUILD_INTERFACE:${PROJECT_SOURCE_DIR}/include>)
+  $<BUILD_INTERFACE:${PROJECT_SOURCE_DIR}/include>
+  $<BUILD_INTERFACE:${PROJECT_SOURCE_DIR}/src/third_party>)
 install(
   TARGETS civetweb-c-library
   EXPORT ${PROJECT_NAME}-targets
@@ -112,75 +113,84 @@ if (CIVETWEB_ENABLE_LUA)
     set(LUA_LIBRARIES "${LUA_INSTALL_DIR}/lib/liblua.a")
     add_dependencies(civetweb-c-library lua)
   else()
-    find_package(Lua)
+    find_package(Lua ${CIVETWEB_LUA_VERSION_MAJOR_MINOR} EXACT)
   endif()
 
   # Lua Filesystem Support
-  string(REPLACE "." "_" LUA_FILESYSTEM_VERSION_UNDERSCORE ${CIVETWEB_LUA_FILESYSTEM_VERSION})
-  ExternalProject_Add(luafilesystem
-    URL "https://github.com/keplerproject/luafilesystem/archive/v_${LUA_FILESYSTEM_VERSION_UNDERSCORE}.tar.gz"
-    URL_MD5 ${CIVETWEB_LUA_FILESYSTEM_MD5_HASH}
-    PREFIX "${CIVETWEB_THIRD_PARTY_DIR}"
-    PATCH_COMMAND ${CMAKE_COMMAND} -E copy
-      "${CMAKE_CURRENT_SOURCE_DIR}/cmake/luafilesystem/CMakeLists.txt" <SOURCE_DIR>/CMakeLists.txt
-    CMAKE_ARGS
-      "-DCMAKE_C_COMPILER=${CMAKE_C_COMPILER}"
-      "-DCMAKE_INSTALL_PREFIX=<INSTALL_DIR>"
-    LOG_DOWNLOAD ${THIRD_PARTY_LOGGING}
-    LOG_UPDATE ${THIRD_PARTY_LOGGING}
-    LOG_CONFIGURE ${THIRD_PARTY_LOGGING}
-    LOG_BUILD ${THIRD_PARTY_LOGGING}
-    LOG_TEST ${THIRD_PARTY_LOGGING}
-    LOG_INSTALL ${THIRD_PARTY_LOGGING})
-  ExternalProject_Get_Property(luafilesystem INSTALL_DIR)
-  set(LUA_FILESYSTEM_INSTALL_DIR ${INSTALL_DIR})
-  unset(INSTALL_DIR)
-  link_directories("${LUA_FILESYSTEM_INSTALL_DIR}/lib")
-  include_directories("${LUA_FILESYSTEM_INSTALL_DIR}/include")
-  set(LUA_LIBRARIES "${LUA_LIBRARIES};${LUA_FILESYSTEM_INSTALL_DIR}/lib/libluafilesystem.a")
-  add_dependencies(civetweb-c-library luafilesystem)
+  if (NOT CIVETWEB_ENABLE_LUA_FILESYSTEM_SHARED)
+    string(REPLACE "." "_" LUA_FILESYSTEM_VERSION_UNDERSCORE ${CIVETWEB_LUA_FILESYSTEM_VERSION})
+    ExternalProject_Add(luafilesystem
+      URL "https://github.com/keplerproject/luafilesystem/archive/v_${LUA_FILESYSTEM_VERSION_UNDERSCORE}.tar.gz"
+      URL_MD5 ${CIVETWEB_LUA_FILESYSTEM_MD5_HASH}
+      PREFIX "${CIVETWEB_THIRD_PARTY_DIR}"
+      PATCH_COMMAND ${CMAKE_COMMAND} -E copy
+        "${CMAKE_CURRENT_SOURCE_DIR}/cmake/luafilesystem/CMakeLists.txt" <SOURCE_DIR>/CMakeLists.txt
+      CMAKE_ARGS
+        "-DCMAKE_C_COMPILER=${CMAKE_C_COMPILER}"
+        "-DCMAKE_INSTALL_PREFIX=<INSTALL_DIR>"
+      LOG_DOWNLOAD ${THIRD_PARTY_LOGGING}
+      LOG_UPDATE ${THIRD_PARTY_LOGGING}
+      LOG_CONFIGURE ${THIRD_PARTY_LOGGING}
+      LOG_BUILD ${THIRD_PARTY_LOGGING}
+      LOG_TEST ${THIRD_PARTY_LOGGING}
+      LOG_INSTALL ${THIRD_PARTY_LOGGING})
+    ExternalProject_Get_Property(luafilesystem INSTALL_DIR)
+    set(LUA_FILESYSTEM_INSTALL_DIR ${INSTALL_DIR})
+    unset(INSTALL_DIR)
+    link_directories("${LUA_FILESYSTEM_INSTALL_DIR}/lib")
+    include_directories("${LUA_FILESYSTEM_INSTALL_DIR}/include")
+    set(LUA_LIBRARIES "${LUA_LIBRARIES};${LUA_FILESYSTEM_INSTALL_DIR}/lib/libluafilesystem.a")
+    add_dependencies(civetweb-c-library luafilesystem)
+  else()
+    set(LUA_LIBRARIES "${LUA_LIBRARIES};${LUA_CDIR}/lfs.so")
+  endif()
 
   # Lua SQLite Support
-  if (${CIVETWEB_LUA_SQLITE_VERSION} VERSION_EQUAL "0.9.3")
-    set(LUA_SQLITE_FILENAME lsqlite3_fsl09w.zip)
-  elseif (${CIVETWEB_LUA_SQLITE_VERSION} VERSION_EQUAL "0.9.2")
-    set(LUA_SQLITE_FILENAME lsqlite3_fsl09v.zip)
-  elseif (${CIVETWEB_LUA_SQLITE_VERSION} VERSION_EQUAL "0.9.1")
-    set(LUA_SQLITE_FILENAME lsqlite3_fsl09t.zip)
+  if (NOT CIVETWEB_ENABLE_LUA_SQLITE_SHARED)
+    if (${CIVETWEB_LUA_SQLITE_VERSION} VERSION_EQUAL "0.9.3")
+      set(LUA_SQLITE_FILENAME lsqlite3_fsl09w.zip)
+    elseif (${CIVETWEB_LUA_SQLITE_VERSION} VERSION_EQUAL "0.9.2")
+      set(LUA_SQLITE_FILENAME lsqlite3_fsl09v.zip)
+    elseif (${CIVETWEB_LUA_SQLITE_VERSION} VERSION_EQUAL "0.9.1")
+      set(LUA_SQLITE_FILENAME lsqlite3_fsl09t.zip)
+    else()
+      message(FATAL_ERROR "The Lua SQLite archive filename is unknown for version ${CIVETWEB_LUA_SQLITE_VERSION}")
+    endif()
+    ExternalProject_Add(luasqlite
+      URL "http://lua.sqlite.org/index.cgi/zip/${LUA_SQLITE_FILENAME}"
+      URL_MD5 ${CIVETWEB_LUA_SQLITE_MD5_HASH}
+      PREFIX "${CIVETWEB_THIRD_PARTY_DIR}"
+      PATCH_COMMAND ${CMAKE_COMMAND} -E copy
+        "${CMAKE_CURRENT_SOURCE_DIR}/cmake/luasqlite/CMakeLists.txt" <SOURCE_DIR>/CMakeLists.txt
+      CMAKE_ARGS
+        "-DCMAKE_C_COMPILER=${CMAKE_C_COMPILER}"
+        "-DCMAKE_INSTALL_PREFIX=<INSTALL_DIR>"
+      LOG_DOWNLOAD ${THIRD_PARTY_LOGGING}
+      LOG_UPDATE ${THIRD_PARTY_LOGGING}
+      LOG_CONFIGURE ${THIRD_PARTY_LOGGING}
+      LOG_BUILD ${THIRD_PARTY_LOGGING}
+      LOG_TEST ${THIRD_PARTY_LOGGING}
+      LOG_INSTALL ${THIRD_PARTY_LOGGING})
+    ExternalProject_Get_Property(luasqlite INSTALL_DIR)
+    set(LUA_SQLITE_INSTALL_DIR ${INSTALL_DIR})
+    unset(INSTALL_DIR)
+    link_directories("${LUA_SQLITE_INSTALL_DIR}/lib")
+    set(LUA_LIBRARIES "${LUA_LIBRARIES};${LUA_SQLITE_INSTALL_DIR}/lib/libluasqlite.a")
+    add_dependencies(civetweb-c-library luasqlite)
   else()
-    message(FATAL_ERROR "The Lua SQLite archive filename is unknown for version ${CIVETWEB_LUA_SQLITE_VERSION}")
+    set(LUA_LIBRARIES "${LUA_LIBRARIES};${LUA_CDIR}/lsqlite3.so")
   endif()
-  ExternalProject_Add(luasqlite
-    URL "http://lua.sqlite.org/index.cgi/zip/${LUA_SQLITE_FILENAME}"
-    URL_MD5 ${CIVETWEB_LUA_SQLITE_MD5_HASH}
-    PREFIX "${CIVETWEB_THIRD_PARTY_DIR}"
-    PATCH_COMMAND ${CMAKE_COMMAND} -E copy
-      "${CMAKE_CURRENT_SOURCE_DIR}/cmake/luasqlite/CMakeLists.txt" <SOURCE_DIR>/CMakeLists.txt
-    CMAKE_ARGS
-      "-DCMAKE_C_COMPILER=${CMAKE_C_COMPILER}"
-      "-DCMAKE_INSTALL_PREFIX=<INSTALL_DIR>"
-    LOG_DOWNLOAD ${THIRD_PARTY_LOGGING}
-    LOG_UPDATE ${THIRD_PARTY_LOGGING}
-    LOG_CONFIGURE ${THIRD_PARTY_LOGGING}
-    LOG_BUILD ${THIRD_PARTY_LOGGING}
-    LOG_TEST ${THIRD_PARTY_LOGGING}
-    LOG_INSTALL ${THIRD_PARTY_LOGGING})
-  ExternalProject_Get_Property(luasqlite INSTALL_DIR)
-  set(LUA_SQLITE_INSTALL_DIR ${INSTALL_DIR})
-  unset(INSTALL_DIR)
-  link_directories("${LUA_SQLITE_INSTALL_DIR}/lib")
-  set(LUA_LIBRARIES "${LUA_LIBRARIES};${LUA_SQLITE_INSTALL_DIR}/lib/libluasqlite.a")
-  add_dependencies(civetweb-c-library luasqlite)
 
   # Lua XML Support
-  if (${CIVETWEB_LUA_XML_VERSION} VERSION_EQUAL "1.8.0")
-    set(LUA_XML_FILENAME LuaXML_130610.zip)
-  elseif (${CIVETWEB_LUA_XML_VERSION} VERSION_EQUAL "1.7.4")
-    set(LUA_XML_FILENAME LuaXML_101012.zip)
-  else()
-    message(FATAL_ERROR "The Lua XML archive filename is unknown for version ${CIVETWEB_LUA_XML_VERSION}")
-  endif()
-  ExternalProject_Add(luaxml
+  if (NOT CIVETWEB_ENABLE_LUA_XML_SHARED)
+    if (${CIVETWEB_LUA_XML_VERSION} VERSION_EQUAL "1.8.0")
+      set(LUA_XML_FILENAME LuaXML_130610.zip)
+    elseif (${CIVETWEB_LUA_XML_VERSION} VERSION_EQUAL "1.7.4")
+      set(LUA_XML_FILENAME LuaXML_101012.zip)
+    else()
+      message(FATAL_ERROR "The Lua XML archive filename is unknown for version ${CIVETWEB_LUA_XML_VERSION}")
+    endif()
+    ExternalProject_Add(luaxml
 # Old:
 #    URL "http://viremo.eludi.net/LuaXML/${LUA_XML_FILENAME}"
 #    URL_MD5 ${CIVETWEB_LUA_XML_MD5_HASH}
@@ -191,58 +201,66 @@ if (CIVETWEB_ENABLE_LUA)
 # An extended version is available at https://github.com/n1tehawk/LuaXML
 # but the last commit there was in 2015
 #
-    URL "https://github.com/n1tehawk/LuaXML/archive/v1.8.0.zip"
-    PREFIX "${CIVETWEB_THIRD_PARTY_DIR}"
+      URL "https://github.com/n1tehawk/LuaXML/archive/v1.8.0.zip"
+      PREFIX "${CIVETWEB_THIRD_PARTY_DIR}"
 #
 # TODO: fix this patch command (needs someone with deeper CMake know how)
-    PATCH_COMMAND ${CMAKE_COMMAND} -E copy
-      "${CMAKE_CURRENT_SOURCE_DIR}/cmake/luaxml/CMakeLists.txt" <SOURCE_DIR>/CMakeLists.txt
-    CMAKE_ARGS
-      "-DCMAKE_C_COMPILER=${CMAKE_C_COMPILER}"
-      "-DCMAKE_INSTALL_PREFIX=<INSTALL_DIR>"
-    LOG_DOWNLOAD ${THIRD_PARTY_LOGGING}
-    LOG_UPDATE ${THIRD_PARTY_LOGGING}
-    LOG_CONFIGURE ${THIRD_PARTY_LOGGING}
-    LOG_BUILD ${THIRD_PARTY_LOGGING}
-    LOG_TEST ${THIRD_PARTY_LOGGING}
-    LOG_INSTALL ${THIRD_PARTY_LOGGING})
-  ExternalProject_Get_Property(luaxml INSTALL_DIR)
-  set(LUA_XML_INSTALL_DIR ${INSTALL_DIR})
-  unset(INSTALL_DIR)
-  link_directories("${LUA_XML_INSTALL_DIR}/lib")
-  set(LUA_LIBRARIES "${LUA_LIBRARIES};${LUA_XML_INSTALL_DIR}/lib/libluaxml.a")
-  add_dependencies(civetweb-c-library luaxml)
+      PATCH_COMMAND ${CMAKE_COMMAND} -E copy
+        "${CMAKE_CURRENT_SOURCE_DIR}/cmake/luaxml/CMakeLists.txt" <SOURCE_DIR>/CMakeLists.txt
+      CMAKE_ARGS
+        "-DCMAKE_C_COMPILER=${CMAKE_C_COMPILER}"
+        "-DCMAKE_INSTALL_PREFIX=<INSTALL_DIR>"
+      LOG_DOWNLOAD ${THIRD_PARTY_LOGGING}
+      LOG_UPDATE ${THIRD_PARTY_LOGGING}
+      LOG_CONFIGURE ${THIRD_PARTY_LOGGING}
+      LOG_BUILD ${THIRD_PARTY_LOGGING}
+      LOG_TEST ${THIRD_PARTY_LOGGING}
+      LOG_INSTALL ${THIRD_PARTY_LOGGING})
+    ExternalProject_Get_Property(luaxml INSTALL_DIR)
+    set(LUA_XML_INSTALL_DIR ${INSTALL_DIR})
+    unset(INSTALL_DIR)
+    link_directories("${LUA_XML_INSTALL_DIR}/lib")
+    set(LUA_LIBRARIES "${LUA_LIBRARIES};${LUA_XML_INSTALL_DIR}/lib/libluaxml.a")
+    add_dependencies(civetweb-c-library luaxml)
+  else()
+    set(LUA_LIBRARIES "${LUA_LIBRARIES};${LUA_CDIR}/LuaXML_lib.so")
+  endif()
 
   # SQLite Support
-  string (REGEX MATCHALL "[0-9]+" SQLITE_VERSION_MATCHES ${CIVETWEB_SQLITE_VERSION})
-  list(GET SQLITE_VERSION_MATCHES 0 SQLITE_VERSION_MAJOR)
-  list(GET SQLITE_VERSION_MATCHES 1 SQLITE_VERSION_MINOR)
-  list(GET SQLITE_VERSION_MATCHES 2 SQLITE_VERSION_PATCH)
-  set(SQLITE_FILE_VERSION ${SQLITE_VERSION_MAJOR}0${SQLITE_VERSION_MINOR}0${SQLITE_VERSION_PATCH}00)
-  ExternalProject_Add(sqlite
-    URL "http://www.sqlite.org/2015/sqlite-amalgamation-${SQLITE_FILE_VERSION}.zip"
-    URL_MD5 ${CIVETWEB_SQLITE_MD5_HASH}
-    PREFIX "${CIVETWEB_THIRD_PARTY_DIR}"
-    PATCH_COMMAND ${CMAKE_COMMAND} -E copy
-      "${CMAKE_CURRENT_SOURCE_DIR}/cmake/sqlite/CMakeLists.txt" <SOURCE_DIR>/CMakeLists.txt
-    CMAKE_ARGS
-      "-DCMAKE_C_COMPILER=${CMAKE_C_COMPILER}"
-      "-DCMAKE_INSTALL_PREFIX=<INSTALL_DIR>"
-    LOG_DOWNLOAD ${THIRD_PARTY_LOGGING}
-    LOG_UPDATE ${THIRD_PARTY_LOGGING}
-    LOG_CONFIGURE ${THIRD_PARTY_LOGGING}
-    LOG_BUILD ${THIRD_PARTY_LOGGING}
-    LOG_TEST ${THIRD_PARTY_LOGGING}
-    LOG_INSTALL ${THIRD_PARTY_LOGGING})
-  ExternalProject_Get_Property(sqlite INSTALL_DIR)
-  set(SQLITE_INSTALL_DIR ${INSTALL_DIR})
-  unset(INSTALL_DIR)
-  link_directories("${SQLITE_INSTALL_DIR}/lib")
-  include_directories("${SQLITE_INSTALL_DIR}/include")
-  set(LUA_LIBRARIES "${LUA_LIBRARIES};${SQLITE_INSTALL_DIR}/lib/libsqlite.a")
-  add_dependencies(civetweb-c-library sqlite)
+  if (NOT CIVETWEB_ENABLE_SQLITE_SHARED)
+    string (REGEX MATCHALL "[0-9]+" SQLITE_VERSION_MATCHES ${CIVETWEB_SQLITE_VERSION})
+    list(GET SQLITE_VERSION_MATCHES 0 SQLITE_VERSION_MAJOR)
+    list(GET SQLITE_VERSION_MATCHES 1 SQLITE_VERSION_MINOR)
+    list(GET SQLITE_VERSION_MATCHES 2 SQLITE_VERSION_PATCH)
+    set(SQLITE_FILE_VERSION ${SQLITE_VERSION_MAJOR}0${SQLITE_VERSION_MINOR}0${SQLITE_VERSION_PATCH}00)
+    ExternalProject_Add(sqlite
+      URL "http://www.sqlite.org/2015/sqlite-amalgamation-${SQLITE_FILE_VERSION}.zip"
+      URL_MD5 ${CIVETWEB_SQLITE_MD5_HASH}
+      PREFIX "${CIVETWEB_THIRD_PARTY_DIR}"
+      PATCH_COMMAND ${CMAKE_COMMAND} -E copy
+        "${CMAKE_CURRENT_SOURCE_DIR}/cmake/sqlite/CMakeLists.txt" <SOURCE_DIR>/CMakeLists.txt
+      CMAKE_ARGS
+        "-DCMAKE_C_COMPILER=${CMAKE_C_COMPILER}"
+        "-DCMAKE_INSTALL_PREFIX=<INSTALL_DIR>"
+      LOG_DOWNLOAD ${THIRD_PARTY_LOGGING}
+      LOG_UPDATE ${THIRD_PARTY_LOGGING}
+      LOG_CONFIGURE ${THIRD_PARTY_LOGGING}
+      LOG_BUILD ${THIRD_PARTY_LOGGING}
+      LOG_TEST ${THIRD_PARTY_LOGGING}
+      LOG_INSTALL ${THIRD_PARTY_LOGGING})
+    ExternalProject_Get_Property(sqlite INSTALL_DIR)
+    set(SQLITE_INSTALL_DIR ${INSTALL_DIR})
+    unset(INSTALL_DIR)
+    link_directories("${SQLITE_INSTALL_DIR}/lib")
+    include_directories("${SQLITE_INSTALL_DIR}/include")
+    set(LUA_LIBRARIES "${LUA_LIBRARIES};${SQLITE_INSTALL_DIR}/lib/libsqlite.a")
+    add_dependencies(civetweb-c-library sqlite)
+  else()
+    set(LUA_LIBRARIES "${LUA_LIBRARIES};/usr/${_GET_LIBDIR}/libsqlite3.a")
+  endif()
 
   # Link all the Lua libraries
+  message(STATUS "LUA_LIBRARIES=${LUA_LIBRARIES}")
   target_link_libraries(civetweb-c-library ${LUA_LIBRARIES})
 endif()
 
@@ -264,7 +282,8 @@ if (CIVETWEB_ENABLE_SERVER_EXECUTABLE)
     endif()
     target_include_directories(
         civetweb-c-executable PUBLIC
-        $<BUILD_INTERFACE:${PROJECT_SOURCE_DIR}/include>)
+        $<BUILD_INTERFACE:${PROJECT_SOURCE_DIR}/include>
+        )
     target_link_libraries(civetweb-c-executable civetweb-c-library)
     if (LIBRT_FOUND)
         target_link_libraries(civetweb-c-executable LIBRT::LIBRT)
@@ -280,7 +299,8 @@ if (CIVETWEB_ENABLE_LUA)
   )
   target_include_directories(
     lua-library PUBLIC
-    $<BUILD_INTERFACE:${PROJECT_SOURCE_DIR}/src/third_party/lua-5.2.4>)
+    $<BUILD_INTERFACE:${PROJECT_SOURCE_DIR}/src/third_party/lua-${CIVETWEB_LUA_VERSION}/src>
+    )
   install(
     TARGETS lua-library
     EXPORT ${PROJECT_NAME}-targets
@@ -308,7 +328,8 @@ if (CIVETWEB_ENABLE_CXX)
 	civetweb-c-library)
   target_include_directories(
     civetweb-cpp PUBLIC
-    $<BUILD_INTERFACE:${PROJECT_SOURCE_DIR}/include>)
+    $<BUILD_INTERFACE:${PROJECT_SOURCE_DIR}/include>
+    )
   install(
     TARGETS civetweb-cpp
     EXPORT ${PROJECT_NAME}-targets
