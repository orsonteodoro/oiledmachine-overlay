<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
  <maintainer type="person">
    <!-- Ebuild fork on the oiledmachine overlay -->
    <email>orsonteodoro@hotmail.com</email>
    <name>Orson Teodoro</name>
  </maintainer>
  <maintainer type="person">
    <!-- Ebuild originator -->
    <email>expeditioneer@gentoo.org</email>
    <name>Dennis Lamm</name>
  </maintainer>
  <longdescription lang="en">
    Firejail is a SUID program that reduces the risk of security breaches by
    restricting the running environment of untrusted applications using Linux
    namespaces and seccomp-bpf. It allows a process and all its descendants to 
    have their own private view of the globally shared kernel resources, such as
    the network stack, process table,
    mount table.

    This is the regular version. For a long term support version see
    sys-apps/firejail-lts.
  </longdescription>
  <ebuild-documentation>
  <![CDATA[
    oiledmachine-overlay ebuild changes and ebuild additions:

      - Improved Xpra support
      - Enable or disable sound forwarding
      - /usr/local/bin wrapper auto generation
      - ROP attack mitigations
      - Support for hardened mallocs

    Ebuild fork goals:

      - Minimize install bloat
      - Make it easier to use program sandboxed
      - Sandboxed on install without user intervention
      - Least privileges corrections

    Wrapper versus symlink

    Firejail can use symlink from /usr/bin/firefail to
    /usr/local/bin/PROFILE_NAME, but it runs /usr/bin/PROGRAM_NAME with
    PROFILE_NAME only if PROGRAM_NAME is the same as PROFILE_NAME.  Some
    programs, however, cannot be paired correctly because the profile name is
    unconventional or the capitalization issue.

    This is why a shell wrapper script is used instead.  The shell wrapper will
    tell Firejail to run CORRECT_PROGRAM_NAME with PROFILE_NAME.  These
    compatiblity wrappers will be autogenerated by the ebuild.  So correctness
    increases but the startup latency will decrease a little because of the
    shell script startup cost.


    Build time environment variables for USE=wrapper

    If the PROFILE_NAME starts with a number, it must be prefixed with the _
    character.

    APPARMOR_PROFILE[PROFILE_NAME] - Set app armor protection.
    Valid values - default, APPARMOR_PROFILE_NAME, unset (default off)

    ARGS[PROFILE_NAME] - Add the raw list of args to the wrapper for full
    control.  To properly sandbox the app with COMMAND[PROGRAM_NAME], the
    program must be limited as much as possible.

    AUTO_BLACKLIST - Disable auto adding wrapper to /usr/local/bin as a space
    delimited list
    Valid values - PROFILE_NAME, unset (permit app)

    COMMAND[PROGRAM_NAME] - Create a wrapper without a profile.
    Valid values - 1 (create), 0 (don't create)

    The COMMAND[PROGRAM_NAME]="1" can be used to increase coverage of
    sandboxed programs typically those without a PROFILE_NAME.  This
    can use all the VAR_NAME[PROFILE_NAME] environment variables.

    LANDLOCK[PROFILE_NAME] - Restrict app file access.
    Valid values - 1 (restrict), 0 (unrestrict), unset (unrestrict)

    LANDLOCK_PROC[PROFILE_NAME] - Restrict proc
    Valid values - no, ro, rw, unset (don't apply)

    LANDLOCK_READ[PROFILE_NAME] - Add read rule path is comma separated
    Valid values - PATH1; PATH1,PATH2; PATH1,PATH2,...; unset (don't apply)

    LANDLOCK_WRITE[PROFILE_NAME] - Add write rule path is comma separated
    Valid values - PATH1; PATH1,PATH2; PATH1,PATH2,...; unset (don't apply)

    LANDLOCK_EXECUTE[PROFILE_NAME] - Add execute rule path is comma separated
    Valid values - PATH1; PATH1,PATH2; PATH1,PATH2,...; unset (don't apply)

    MALLOC_BACKEND[PROFILE_NAME] - Set the hardened allocator
    Valid values - hardened_malloc, mimalloc, scudo, system-malloc,
    unset (It will fallback to hardened malloc followed by ptmalloc.)

    Allocator           | HO | OOB | UAF | HF     | FP          | TC | MTE   | Examples
    bmalloc             | y  | y   | y   | n      | poison      | n  | n     | Older WebKitGTK release
    jemalloc            | y  | y   | y   | n      | none        | n  | n     | Mono, Blender, MariaDB, QEMU
    libpas              | y  | y   | y   | y[1]   | poison/zero | y  | n     | Latest WebKitGTK
    hardened_malloc     | y  | y   | y   | y[2]   | poison      | y  | n     | GrapheneOS
    mimalloc            | y  | y   | y   | y[3]   | config      | n  | n     | AI/ML (pyTorch, ONNX Runtime)
    scudo               | y  | y   | y   | y[4]   | poison      | n  | y     | Android
    PartitionAlloc      | y  | y   | y   | y[5]   | poison      | y  | y     | Chromium
    ptmalloc            | n  | n   | n   | n      | none        | n  | n     | glibc, Linux userland apps
    tcmalloc            | y  | y   | y   | n      | none        | n  | n     | Databases (Redis, MariaDB)          
    slub                | y  | y   | y   | y[6]   | none        | n  | n     | Kernel

    For sensitive data apps:  KASLR, HO=y, OOB=y, UAF=y, FP=poison|zero are required for security-critical.
    For browsers:             KASLR, HO=y, OOB=y, UAF=y, FP=poison|zero, TC=y are required for security-critical.

    HO = Heap Overflow mitigation
    OOB = Out of Bounds mitigation
    ASLR = Address Space Layout Randomization protection (userspace fallback if kernel was not built with KASLR)
    FP = secure free sensitive wipe policy
    HF = hash function used for ASLR
    TC = Type confusion mitigation
    MTE = Memory Type Extension (arm64 only)
    UAF = Use after free mitigation
    [1] = Either Xorshift PRNG or ARC4
    [2] = ChaCha8
    [3] = ChaCha20
    [4] = KASLR required & linear function
    [5] = ALSR, linear PSNR
    [6] = via KASLR

    OOM[PROFILE_NAME] - Set the normalized number of pages for the OOM (Out Of Memory) killer.
    Higher values mean likely killed based on OOM killer context.
    Valid values:
    For root: -1000 to 1000
    For non-root:  0 to 1000 
    -value - deduct the badness score by this amount.
    
    base_score = n_task_ram_pages + n_task_swap_pages + n_page_table_pages # typically < 100 per task
    badness_value = base_score + n_normalized_pages

    PATH_CORRECTION[PROFILE_NAME] - Set the correct path to the binary package.


    SCOPE[PROFILE_NAME] - Scope of the wrapper.
    Valid values

    ban - do not generate wrapper (Aliases:  blacklist, blacklisted)

    Note:

    * The SCOPE[PROFILE_NAME] can override the ebuild defaults for ebuilds that
      use commands that should be in the conflicting set.


    SCUDO_FREE_IMMEDIATE[PROFILE_NAME] - Free the keys in the heap immediately.
    Valid values:
    1 (clear immediately for mitigation against cold-boot-attack and DMA based attacks.)
    0 (delayed free for mitigation against use-after-free heap attacks.)

    SECCOMP[PROFILE_NAME] - Enable seccomp sandboxing with defaults
    Valid values:  1 (enable), 0 (disable/default), unset (disable)

    SECCOMP_BLOCK[PROFILE_NAME] - Enable seccomp with blacklisted syscalls separated with comma
    Valid values:  SYSCALL1; SYSCALL1,SYSCALL2; SYSCALL1,SYSCALL2,...; unset (don't apply)

    SECCOMP_KEEP[PROFILE_NAME] - Enable seccomp with whitelisted syscalls separated with comma
    Valid values:  SYSCALL1; SYSCALL1,SYSCALL2; SYSCALL1,SYSCALL2,...; unset (don't apply)

    XEPHYR_WH[PROFILE_NAME] - Set the default window size for X11 apps that
    are sandboxed with the zephyr backend.
    Valid values:  WIDTHxHEIGHT, 800x600 (default)

    X_BACKEND[PROFILE_NAME] - Select the X11 sandbox backend.
    Valid values:
    unsandboxed      - Do not add any flags.  Hardware accelerated OpenGL
                       (gaming-unsandbox, opengl-unsandboxed, none, disable are
                       acceptable aliases)
    xephyr           - Runs the program using Xephyr
    xpra             - Runs the program using Xpra
                       (gaming-sandboxed, opengl-sandboxed are acceptable
                       aliases)
    xvfb             - Runs the program using Xvfb
                       (headless, /dev/null are an acceptable aliases)
    unset            - Default as Xpra or Xephyr if X11 app.  Otherwise, it will
                       default to unsandboxed X11 for CLI/TUI apps in a virtual
                       terminal.  If the CLI/TUI app is running under a virtual
                       terminal emulator with the x-terminal-emulator profile,
                       it will be X11 isolated.  However, the tabs might not
                       have isolation among each other.

    X Backend      | Status     | Flaws                       | Benefits                    | OpenGL support
    unsandboxed    | works      | no frame grab isolation and | fastest fps, fastest start  | yes, fast
                   |            | no input isolation          |                             |
    xephyr         | works      | window size inconsistencies | fast start, faster scroll   | yes, but slow
    xpra           | works      | slow start                  | no window size problems     | yes, but slow
    xpra-virtualgl | works [2]  | slow start                  | no window size problems     | yes, but slow
    xorg [1][3]    | broken [2] |                             |                             | 
    xvfb           | untested   |                             | hidden output               | untested

    [1] Workarounds may compromise security.  Issue 1741
    [2] Disabled
    [3] Known as xcsecurity, x11 security extension

    Tests performed with WebGL Aquarium and software rendering override

    chromium --disable-gpu no firejail:  2 fps
    chromium no firejail:  60 fps
    chromium with firejail --x11=xephyr:  11 fps
    chromium with firejail --x11=xpra and opengl=yes:  7 fps
    chromium with firejail --x11=xpra and opengl=no:  7 fps
    chromium with firejail --x11=xpra-virtualgl and opengl=no:  7 fps
    chromium with firejail --x11=xpra-virtualgl and opengl=yes:  7 fps
    chromium with firejail without --x11 (same as X_BACKEND[PROFILE_NAME]=unsanboxed|disable|none):  60 fps

    Variables are in all capitals.

    Examples:

    Contents of /etc/portage/env/firejail.conf:

      APPARMOR_PROFILE["chromium"]="chromium-browser"
      APPARMOR_PROFILE["firefox"]="default"
      ARGS[_7z]="--noprinters"
      AUTO_BLACKLIST="node cargo"
      LANDLOCK["chromium"]=1
      LANDLOCK["firefox"]=1
      MALLOC_BACKEND["keepassxc"]="mimalloc"
      MALLOC_BACKEND["mpv"]="scudo"
      MALLOC_BACKEND["mplayer"]="hardened_malloc"
      MALLOC_BACKEND["spotify"]="system-malloc"
      PATH_CORRECTION["spotify"]="/opt/spotify/spotify-client/spotify"
      SCOPE[cargo]="ban"
      SCOPE[node]="local"
      SCUDO_FREE_IMMEDIATE["keepassxc"]=1
      SECCOMP["dillo"]=1
      XEPHYR_WH["chromium"]="1918x1058"
      XEPHYR_WH["firefox"]="1918x1058"
      X_BACKEND["chromium"]="xephyr"
      X_BACKEND["firefox"]="xpra"
      X_BACKEND["spotify"]="xephyr"
      X_BACKEND["xchat"]="auto"

      COMMAND["upscayl"]=1
      ARGS["upscayl"]="--nosound --noprinters --noprofile"
      MALLOC_BACKEND["upscayl"]="mimalloc"
      PATH_CORRECTION["upscayl"]="/usr/bin/upscayl"
      X_BACKEND["upscayl"]="xpra"

    Contents of /etc/portage/package.env:

      sys-apps/firejail firejail.conf


    Analysis and explanations:

    /etc/portage/env/firejail.conf is a fixed path.  It should not be
    customizable.  This is to make associative arrays work.

    By default in this ebuild, scudo will free memory blocks with a delay.  This
    delay is to mitigate against use-after-free.  This delay is dangerous for
    cold boot attacks or maybe DMA based ones since freeing blocks is not
    eager but event based on size.

    This is why we choose the mimalloc which does eager free.  The keychain has
    to be purged ASAP after the program has been killed without a chance of
    calling its graceful cleaner routine.

    By default, paths are assumed to be /usr/bin/PROGRAM_NAME.  You may want
    to fix the profile name paring with PATH_CORRECTION for binary packages.


    Auto adding/generating wrappers with USE=auto with USE=wrapper

    The auto USE flag can be used to auto add wrappers to /usr/local/bin with
    AUTO_BLACKLIST[PROFILE_NAME].  This will sandbox more X apps for more
    cautious people but increase protection and decrease data theft from biased
    programs.  The BLACKLIST is to prevent an unbootable system, prevent a
    broken package manager, or those those prefer some games/apps to be more
    performant.

    When a program is AUTO_BLACKLIST, it means that it cannot be a
    wrapper/symlink to /usr/local/bin/PROGRAM_NAME, but it is maybe
    recommened to add a wrapper/symlink to some location in the home dir
    so the non-root user can increase their sandbox coverage.


    What should be sandboxed or wrapped/symlinked to
    /usr/local/bin/PROGRAM_NAME?

    1. Proprietary programs which are considered untrusted
    2. End of Life programs/versions
    3. Binary only programs
    4. Network based programs
    5. Programs that are capable of loading user generated content
    6. Programs that are statically linked to vulnerable libraries
    7. Programs that have a unpatched vulnerability
    8. Doubious programs

    If a program does not have a PROFILE_NAME.profile, you should either make a
    .profile which is preferred or use the COMMAND environment variable.


    What should NOT be sandboxed or NOT wrapped/symlinked to
    /usr/local/bin/PROGRAM_NAME?

    1a. Anything that could interfere with portage
    1b. Anything that prevents emerge @system or the unemerging of Firejail
    2a. Anything that could break init
    2b. Anything that could break the display manager or login
    3. Programs that use the root user
    4. Anything that prevents access or the loading of the root user account
    5. Anything that interferes with updating bootloader/initramfs/kernel
    6. Programs that may be used in ebuilds or build scripts

    Like was mentioned above, limited users should try to increase the sandbox
    coverage by building links/wrappers within the user's home dir.

    You can use the AUTO_BLACKLIST or delete /usr/local/bin/PROGRAM_NAME
    if you suspect breakage in your configuration.
    

    Next round of proposals.
  ]]>
  </ebuild-documentation>
  <upstream>
    <remote-id type="cpe">cpe:/a:firejail_project:firejail</remote-id>
    <remote-id type="github">netblue30/firejail</remote-id>
  </upstream>
  <use>
    <flag name="auto">
      Auto add wrappers to /usr/local/bin if the program exists.
    </flag>
    <flag name="apparmor">
      Enable support for custom AppArmor profiles
    </flag>
    <flag name="chroot">
      Enable chrooting to custom directory
    </flag>
    <flag name="contrib">
      Install contrib scripts
    </flag>
    <flag name="dbusproxy">
      Enable D-Bus proxy support
    </flag>
    <flag name="file-transfer">
      Enable file transfers between sandboxes and the host system
    </flag>
    <flag name="globalcfg">
      Enable global config file
    </flag>
    <flag name="hardened_malloc">
      Enable support for hardened_malloc as a hardened allocator.
    </flag>
    <flag name="landlock">
      Enable support for the kernel's Landlock Linux Security Module (LSM).
    </flag>
    <flag name="mimalloc">
      Enable support for mimalloc as a hardened allocator.
    </flag>
    <flag name="network">
      Enable networking features
    </flag>
    <flag name="overlayfs">
      Enable overlayfs
    </flag>
    <flag name="private-home">
      Enable private home feature
    </flag>
    <flag name="scudo">
      Enable support for Scudo as a hardened allocator.
    </flag>
    <flag name="seccomp">
      Enable system call filtering
    </flag>
    <flag name="selfrando">
      Enable Selfrando to mitigate against ROP attacks by shuffling functions,
      which may contain ROP gadgets, using ChaCha20 as the PSRNG (Pseudo
      Random Number Generator).

      If the USE flag is disabled, it will do ROP mitigations using
      shuffle-sections linker option.
        - For mold, it will use Fisher-Yates Shuffing with Xorshift PSRNG
          with a linear-modulo equation.
        - For lld, it will use std::shuffle with Mersenne Twister (mt19937)
          PSRNG.
    </flag>
    <flag name="selinux">
      Enable SELinux labeling support
    </flag>
    <flag name="test">
      Performs basic testing
    </flag>
    <flag name="test-profiles">
      Performs testing on the Firejail profiles.  Expect longer testing time.
    </flag>
    <flag name="test-x11">
      Performs testing on the X11 portions
    </flag>
    <flag name="userns">
      Enable attaching a new user namespace to a sandbox (--noroot option)
    </flag>
    <flag name="X">
      Enable X11 sandboxing for GUIs in restricted untrusted mode.
      (It may crash programs or programs may not prefer untrusted mode.)
    </flag>
    <flag name="xcsecurity">
      Enable X security extension support for windowed apps.
    </flag>
    <flag name="xpra">
      Enable Xpra support for windowed apps and better OpenGL support.
    </flag>
    <flag name="xvfb">
      Enable Xvfb support for sandboxing remote access or headless servers.
    </flag>
    <flag name="xephyr">
      Enable Xephyr support for windowed apps.
    </flag>
    <flag name="wrapper">
      Add USE enabled wrappers to /etc/local/bin to immediately use the program
      sandboxed. (EXPERIMENTAL)
    </flag>
  </use>
</pkgmetadata>
