<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
<maintainer type="project">
	<!-- ebuild originator -->
	<email>media-video@gentoo.org</email>
</maintainer>
<longdescription>
	The oiledmachine-overlay provides this ebuild for CFI hardening and
	enablement of PGO optimization.

	USE flag status:
		pgo - in development
		cfi - in development

	PGO optimization requires several steps:
	(1) Fetch assets to train with.  They should be licensed under
	public-domain, CC0-1.0, or your own assets.  They need to be
	60 fps, 4k, and at least 3 seconds long for video PGO training.
	For audio training, pick 3 samples 15 seconds each.
	These high quality samples will be used to generate lower
	quality samples.  The long 30 second requirement is to ensure
	sufficient coverage of dynamic range.
	(2) Emerge FFmpeg the first time to get the PGO toolchain
	installed.
	(3) Configure the following variables:

		FFMPEG_PGO_VIDEO
		FFMPEG_PGO_AUDIO_VOICE_00
		FFMPEG_PGO_AUDIO_VOICE_01
		FFMPEG_PGO_AUDIO_VOICE_02
		FFMPEG_PGO_AUDIO_VOICE_03
		FFMPEG_PGO_AUDIO_VOICE_04
		FFMPEG_PGO_AUDIO_VOICE_05
		FFMPEG_PGO_AUDIO_VOICE_06
		FFMPEG_PGO_AUDIO_VOICE_07
		FFMPEG_PGO_AUDIO_VOICE_08
		FFMPEG_PGO_AUDIO_VOICE_09
		FFMPEG_PGO_AUDIO_VOICE_10
		FFMPEG_PGO_AUDIO_RADIO_00
		FFMPEG_PGO_AUDIO_RADIO_01
		FFMPEG_PGO_AUDIO_RADIO_02
		FFMPEG_PGO_AUDIO_RADIO_03
		FFMPEG_PGO_AUDIO_RADIO_04
		FFMPEG_PGO_AUDIO_RADIO_05
		FFMPEG_PGO_AUDIO_RADIO_06
		FFMPEG_PGO_AUDIO_RADIO_07
		FFMPEG_PGO_AUDIO_RADIO_08
		FFMPEG_PGO_AUDIO_RADIO_09
		FFMPEG_PGO_AUDIO_RADIO_10
		FFMPEG_PGO_AUDIO_MUSIC_INSTRUMENTAL_00
		FFMPEG_PGO_AUDIO_MUSIC_INSTRUMENTAL_01
		FFMPEG_PGO_AUDIO_MUSIC_INSTRUMENTAL_02
		FFMPEG_PGO_AUDIO_MUSIC_INSTRUMENTAL_03
		FFMPEG_PGO_AUDIO_MUSIC_INSTRUMENTAL_04
		FFMPEG_PGO_AUDIO_MUSIC_INSTRUMENTAL_05
		FFMPEG_PGO_AUDIO_MUSIC_INSTRUMENTAL_06
		FFMPEG_PGO_AUDIO_MUSIC_INSTRUMENTAL_07
		FFMPEG_PGO_AUDIO_MUSIC_INSTRUMENTAL_08
		FFMPEG_PGO_AUDIO_MUSIC_INSTRUMENTAL_09
		FFMPEG_PGO_AUDIO_MUSIC_INSTRUMENTAL_10
		FFMPEG_PGO_AUDIO_VOCAL_MUSIC_00
		FFMPEG_PGO_AUDIO_VOCAL_MUSIC_01
		FFMPEG_PGO_AUDIO_VOCAL_MUSIC_02
		FFMPEG_PGO_AUDIO_VOCAL_MUSIC_03
		FFMPEG_PGO_AUDIO_VOCAL_MUSIC_04
		FFMPEG_PGO_AUDIO_VOCAL_MUSIC_05
		FFMPEG_PGO_AUDIO_VOCAL_MUSIC_06
		FFMPEG_PGO_AUDIO_VOCAL_MUSIC_07
		FFMPEG_PGO_AUDIO_VOCAL_MUSIC_08
		FFMPEG_PGO_AUDIO_VOCAL_MUSIC_09
		FFMPEG_PGO_AUDIO_VOCAL_MUSIC_10

	to the abspath to your asset(s). Only one asset can be used for each
	variable.  The reason for the long list is to ensure dynamic range
	coverage based on typical use.  One may add samples across decades,
	across genres, across live or studio so that the codecs do not
	get parts deoptimized in the PGO process.  It is unnecessary to
	fill all of them out.  For example one may inadvertantly optimize
	for 60s music once only.  These allow to specify more so that
	contemporary music or scenarios also gets optimized.  One may
	inadvertantly cover women radio quality but inadvertantly
	deoptimize for male or lgtbtqia.
	(4) Setup FFMPEG_PGO_VIDEO_CODECS, FFMPEG_PGO_AUDIO_CODECS,
	FFMPEG_PGO_CODECNAME_ARGS, FFMPEG_PGO_CODECNAME_ARGS_LOSSLESS,
	per-package envvars.  See below for details.
	(5) Emerge FFmpeg again with an optimized PGO build.
	
	FFMPEG_PGO_VIDEO_CODECS is a string separated list of elements.
	Each element is in this format vencoder:vdecoder:ext:tags.

	  The value of vencoder matches  ffmpeg -codecs | grep -E -e "[D.][E][V][I.][L.][S.] .*"
	  The value of vdecoder matches  mpv --vd=help
	  The value of ext matches  ffmpeg -formats
	  The value of tags may be added for pgo-custom-video providing metadata
	  for enablement of special optimization options.  Multiple tags
	  may be appended by comma and spaces replaced with _.

	Example:
	FFMPEG_PGO_VIDEO_CODECS=" libvpx-vp9:libvpx-vp9:webm:"

	FFMPEG_PGO_AUDIO_CODECS is a string separated list of elements.
	Each element is in this format ascenario:aencoder:adecoder:ext:tags.

	  The value of aencoder matches  ffmpeg -codecs | grep -E -e "[D.][E][A][I.][L.][S.] .*"
	  The value of adecoder matches  mpv --ad=help
	  The value of ext matches  ffmpeg -formats
	  The value of a ascenario can be voice, radio, music.
	  The value of tags may be added for pgo-custom-audio providing metadata
	  for enablement of special optimization options.  Multiple tags
	  may be appended by comma and spaces replaced with _.

	Each codec can be supplied additional per-package envvar args to
	pass to ffmpeg in this general form:

	FFMPEG_PGO_CODECNAME_ARGS
	FFMPEG_PGO_CODECNAME_ARGS_LOSSLESS

	FFMPEG_PGO_VIDEO_CODECS=" voice:libopus:libopus:webm: music:libvorbis:libvorbis:ogg:high_profile"

	replacing CODECNAME with uppercases and hyphens with underscores.
	For example, if one wanted to train an imaginary codec libfoo-bar,
	you need to set the variables FFMPEG_PGO_LIBFOO_BAR_ARGS
	or FFMPEG_PGO_LIBFOO_BAR_ARGS_LOSSLESS.  These args correspond to
	additional  ffmpeg -h full  codec settings for that codec.  You
	should change them to the type of performance or quality settings
	you want to use typically.  Setting the -crf or the -threads is
	something you should set.

	The variables with _LOSSLESS suffix should only add arguments that
	modify performance and not the framerate or quality.

	Both FFMPEG_PGO_VIDEO_CODECS and FFMPEG_PGO_AUDIO_CODECS are for
	use only for the ffmpeg codebase.  Using another external codec
	in an external ebuild requires that ebuild be modified for
	PGO.

	The cbr and vbr trainers for audio PGO training have additional
	envvars.  Let's pretend that there is an imaginary codec called
	foo.  Foo supports bitrates between 64 and 1411.  We can support
	only discrete values for PGO training.

	# Use this to support 64 kbps, 128 kbps, 256 kbps, 320 kbps, 1411 kbps
	FFMPEG_PGO_CBR_TABLE_FOO_MUSIC="128 256 320 1411"
	FFMPEG_PGO_CBR_TABLE_FOO_RADIO="64"
	FFMPEG_PGO_CBR_TABLE_FOO_VOICE="32"

	The codec will match the suffix with the asset scenario to
	not waste time on unlikely parings encountered in the real world.

	Foo also can be used for VBR encoding.  The user needs to supply
	the ffmpeg option and the value.

	# Train with -vbr 1, -vbr 2, -vbr 3, -vbr 4
	FFMPEG_PGO_VBR_OPTION_FOO="-vbr"
	FFMPEG_PGO_VBR_TABLE_LIBFOO_FOO_MUSIC="7 8 9"
	FFMPEG_PGO_VBR_TABLE_LIBFOO_FOO_RADIO="2 3"

	It is recommended to only train codecs that reflect typical use.
	Not doing so will result in increased code size and performance
	degradation.

	Since it would be impratical to permute and PGO train the
	possible features and settings of the software to PGO optimize, the
	pgo-custom-audio and pgo-custom-video USE flags were provided to
	allow people to script their own PGO trainers.  A per-package
	patch must be provided as well as the pgo-custom-audio.sh
	for the pgo-custom-audio USE flag and/or pgo-custom-video.sh
	for the pgo-custom-video USE flag of ${S}.  You may also define
	additional per-package envvar assets.  See the ebuild
	for ways to execute the sandboxed FFmpeg and ways to use
	the variables.

	One may choose Full CFI (cfi USE flag alone), or a balanced
	performant CFI with specific combo of options (all or some of
	cfi-cast, cfi-icall, cfi-vcall) at the expense of security.
	Either cfi-vcall or cfi is necessary for forward edge
	protection.  Backward edge protection is provided by the
	shadow-call-stack USE flag.


	Binary hardening:

	Hardening is required for some production www browsers to mitigate
	against attacks from untrusted assets.

	For hardened profiles, it will fall back to the implied hardened profile
	with noexecstack.

	For non-hardened profiles, there is more flexibility depending on speed
	and security tradeoff choice.  The below are mutually exclusive.
	For more details, see the ebuild.  The differences are really the stack
	protection levels and mitigation against newer threats.

	# Apply default hardened distro settings on non-hardened profiles
	hardened USE flag ON, envar: USE_HARDENED_PROFILE_DEFAULTS=1

	# Apply hardened upstream settings on non-hardened profiles
	hardened USE flag ON, envar: USE_HARDENED_PACKAGE_DEFAULTS=1

	# Use hardened browser settings on non-hardened profiles
	hardened USE flag ON, envar: unset USE_HARDENED_PROFILE_DEFAULTS and
	unset USE_HARDENED_PACKAGE_DEFAULTS

	All hardened profiles and hardened USE flag users will include
	nonexecstack.  The default settings already cover and meet or exceed
	the browser security expectations, but you still need to enable
	the hardened USE flag to meet the security requirements of the
	browser.
</longdescription>
<use>
	<!-- added to ebuild by oiledmachine-overlay -->
	<flag name="cfi">Build with full CFI with all schemes</flag>
	<flag name="cfi-cast">Build with cfi-cast</flag>
	<flag name="cfi-icall">Build with cfi-icall</flag>
	<flag name="cfi-vcall">Build with cfi-vcall with forward edge
		protection.</flag>
        <flag name="cross-dso-cfi">Build shared libs with Cross-DSO CFI mode</flag>
	<flag name="full-relro">Build with Full RELRO</flag>
	<flag name="libcxx">Link against the more secured libcxx package.</flag>
	<flag name="lto">Use link time optimization.</flag>
	<flag name="pgo-custom-audio">Use a custom profile guided optimization
		script to train video codecs with.  Use this for video filter
		training as well.</flag>
	<flag name="pgo-custom-video">Use a custom profile guided optimization
		script to train video codecs with.  Use this for audio filter
		training as well.</flag>
	<flag name="pgo-trainer-audio-cbr">Use the CBR PGO audio trainer.</flag>
	<flag name="pgo-trainer-audio-vbr">Use the VBR PGO audio trainer.</flag>
	<flag name="pgo-trainer-audio-lossless">Use the lossless PGO audio
		trainer.</flag>
	<flag name="pgo-trainer-video-2-pass-constrained-quality">Performs an
		addtional 2 pass training.  Two pass improves quality and rate
		control.  This step can be skipped for live streamers.</flag>
	<flag name="pgo-trainer-video-constrained-quality">Use the 1 pass
		constrained quality PGO video trainer.</flag>
	<flag name="pgo-trainer-video-lossless">Use the lossless PGO video
		trainer.</flag>
	<flag name="ssp">Build with stack smashing protection</flag>
	<!-- For license compatibility checking -->
	<!-- Deal with the restrictive first then back to the permissive. -->
	<flag name="apache2_0">Checks Apache-2.0 license compatibility</flag>
	<flag name="gpl2">Checks GPL-2.0 license compatibility</flag>
	<flag name="gpl2x">Checks GPL-2.0+ license compatibility</flag>
	<flag name="gpl3">Checks GPL-3 license compatibility</flag>
	<flag name="lgpl2">Checks LGPL-2 license compatibility</flag>
	<flag name="lgpl2x">Checks LGPL-2.0+ license compatibility</flag>
	<flag name="lgpl2_1">Checks LGPL-2.1 license compatibility</flag>
	<flag name="lgpl2_1x">Checks LGPL-2.1+ license compatibility</flag>
	<flag name="lgpl3">Checks LGPL-3.0 license compatibility</flag>
	<flag name="mpl2_0">Checks MPL-2.0 license compatibility</flag>
	<flag name="debug">Relax license restrictions</flag>

	<!-- modified -->
	<!-- The gpl USE flag should be replaced with gpl2 USE flag -->
	<flag name="gpl">Synonym for the gpl2 USE flag to build a GPL-2.0 (only) package.  Certain license incompatibilities may be encountered.  This USE flag is kept for compatibility.</flag>

	<!-- added by ebuild originators -->
	<flag name="amr">Enables Adaptive Multi-Rate Audio support</flag>
	<flag name="amrenc">Enables Adaptive Multi-Rate Audio encoding support with <pkg>media-libs/vo-amrwbenc</pkg>.</flag>
	<flag name="appkit">Enables Apple AppKit framework</flag>
	<flag name="bluray">Enable playback of Blu-ray filesystems</flag>
	<flag name="bs2b">Enables <pkg>media-libs/libbs2b</pkg> based Bauer stereo-to-binaural filter.</flag>
	<flag name="cdio">Enables audio CD grabbing with <pkg>dev-libs/libcdio</pkg>.</flag>
	<flag name="chromaprint">Enables audio fingerprinting support with <pkg>media-libs/chromaprint</pkg>.</flag>
	<flag name="chromium">Builds libffmpeg.so to enable media playback in Chromium-based browsers like Opera and Vivaldi.</flag>
	<flag name="codec2">Enables codec2 low bit rate speech codec support via <pkg>media-libs/codec2</pkg>.</flag>
	<flag name="cpudetection">Enables runtime CPU detection (useful for bindist, compatibility on other CPUs)</flag>
	<flag name="cuda">Enables CUDA-based acceleration. Mostly used for specific filters.</flag>
	<flag name="dav1d">Enables AV1 decoding via <pkg>media-libs/dav1d</pkg>.</flag>
	<flag name="fdk">Use external fdk-aac library for AAC encoding</flag>
	<flag name="flite">Adds a text-to-speech filter based on <pkg>app-accessibility/flite</pkg>.</flag>
	<flag name="frei0r">Enable frei0r wrapping in libavfilter</flag>
	<flag name="fribidi">Enables fribidi support in the drawtext filter.</flag>
	<flag name="gcrypt">Enables gcrypt support: Needed for rtmp(t)e support if openssl, librtmp or gmp is not used.</flag>
	<flag name="gme">Enables support for <pkg>media-libs/game-music-emu</pkg> for playing various video game music formats.</flag>
	<flag name="hardcoded-tables">Use pre-calculated tables rather than calculating them on the fly.</flag>
	<flag name="iec61883"> Support for FireWire DV/HDV input device using <pkg>media-libs/libiec61883</pkg>.</flag>
	<flag name="kvazaar">Enables <pkg>media-libs/kvazaar</pkg> based HEVC encoder.</flag>
	<flag name="libaom">Enables <pkg>media-libs/libaom</pkg> based AV1 codec support.</flag>
	<flag name="libaribb24">Enables ARIB text and caption decoding via <pkg>media-libs/aribb24</pkg>.</flag>
	<flag name="libdrm">Enables <pkg>x11-libs/libdrm</pkg> support for better screen grabbing and hardware accelerated codecs.</flag>
	<flag name="libilbc">Enables iLBC de/encoding via <pkg>media-libs/libilbc</pkg>.</flag>
	<flag name="librtmp">Enables Real Time Messaging Protocol using librtmp (<pkg>media-video/rtmpdump</pkg>) in addition to FFmpeg's native implementation.</flag>
	<flag name="libsoxr">Enables audio resampling through <pkg>media-libs/soxr</pkg>.</flag>
	<flag name="libtesseract">Enables the OCR filter via <pkg>app-text/tesseract</pkg>.</flag>
	<flag name="libv4l">Uses <pkg>media-libs/libv4l</pkg> for video4linux instead of direct calls. Adds support for more devices via the userspace library.</flag>
	<flag name="libxml2">Uses <pkg>dev-libs/libxml2</pkg> to enable dash demuxing support.</flag>
	<flag name="lv2">Enables lv2 audio filter wrapper.</flag>
	<flag name="mipsdspr1">Enables MIPS DSP ASE R1 optimizations.</flag>
	<flag name="mipsdspr2">Enables MIPS DSP ASE R2 optimizations.</flag>
	<flag name="mipsfpu">Enables floating point MIPS optimizations.</flag>
	<flag name="mmal">Enables Multi-Media Abstraction Layer (MMAL) decoding support: Available e.g. on the Raspberry Pi.</flag>
	<flag name="network">Enables network streaming support</flag>
	<flag name="opencl">Enable OpenCL support</flag>
	<flag name="openh264">Enables H.264 encoding suppoprt via <pkg>media-libs/openh264</pkg>.</flag>
	<flag name="openssl">Enables <pkg>dev-libs/openssl</pkg> support. Adds support for encrypted network protocols (TLS/HTTPS).</flag>
	<flag name="pic">Force shared libraries to be built as PIC (this is slower)</flag>
	<flag name="postproc">Build and install libpostproc.</flag>
	<flag name="rav1e">Enables AV1 encoding support via <pkg>media-video/rav1e</pkg>.</flag>
	<flag name="rubberband">Adds time-stretching and pitch-shifting audio filter based on <pkg>media-libs/rubberband</pkg>.</flag>
	<flag name="snappy">Enable <pkg>app-arch/snappy</pkg> support. Required for e.g. Vidvox Hap encoder.</flag>
	<flag name="sndio">Enable support for the <pkg>media-sound/sndio</pkg> backend</flag>
	<flag name="srt">Enable support for Secure Reliable Transport (SRT) via <pkg>net-libs/srt</pkg></flag>
	<flag name="ssh">Enable SSH/sftp support via <pkg>net-libs/libssh</pkg>.</flag>
	<flag name="twolame">Enables MP2 encoding via <pkg>media-sound/twolame</pkg> as an alternative to the internal encoder.</flag>
	<flag name="vidstab">Enables video stabilization filter using vid.stab library (<pkg>media-libs/vidstab</pkg>).</flag>
	<flag name="vpx">Enables VP8 and VP9 codec support using libvpx: Decoding does not require this to be enabled but libvpx can also be used for decoding; encoding requires this useflag to be enabled though.</flag>
	<flag name="vulkan">Enables support for the vulkan API for GPU offload.</flag>
	<flag name="x265">Enables HEVC encoding with <pkg>media-libs/x265</pkg>.</flag>
	<flag name="zeromq">Enables <pkg>net-libs/zeromq</pkg> support with the zmq/azmq filters.</flag>
	<flag name="zimg">Enables <pkg>media-libs/zimg</pkg> based scale filter.</flag>
	<flag name="zvbi">Enables <pkg>media-libs/zvbi</pkg> based teletext decoder.</flag>
</use>
<slots>
	<slot name="0">For building against. This is the only slot that provides
	headers and command line tools. Binary compatibility slots come and go
	as required, so always pin dependencies to this slot when appropriate.</slot>
</slots>
</pkgmetadata>
