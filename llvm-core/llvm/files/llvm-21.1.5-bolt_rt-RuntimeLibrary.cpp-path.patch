
Subject:  Respect multilib

//===- bolt/RuntimeLibs/RuntimeLibrary.h - Runtime Library ------*- C++ -*-===//
//
// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
// See https://llvm.org/LICENSE.txt for license information.
// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
//
//===----------------------------------------------------------------------===//

//===- bolt/RuntimeLibs/HugifyRuntimeLibrary.cpp - Hugify RT Library ------===//
//
// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
// See https://llvm.org/LICENSE.txt for license information.
// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
//
//===----------------------------------------------------------------------===//

//===- bolt/RuntimeLibs/InstrumentationRuntimeLibrary.cpp -----------------===//
//
// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
// See https://llvm.org/LICENSE.txt for license information.
// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
//
//===----------------------------------------------------------------------===//

//===- bolt/RuntimeLibs/RuntimeLibrary.cpp - Runtime Library --------------===//
//
// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
// See https://llvm.org/LICENSE.txt for license information.
// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
//
//===----------------------------------------------------------------------===//

--- a/bolt/include/bolt/RuntimeLibs/RuntimeLibrary.h	2025-11-03 01:35:47.000000000 -0800
+++ b/bolt/include/bolt/RuntimeLibs/RuntimeLibrary.h	2025-11-10 06:53:51.834843173 -0800
@@ -60,7 +60,8 @@ protected:
 
   /// Get the full path to a runtime library specified by \p LibFileName and \p
   /// ToolPath.
-  static std::string getLibPathByToolPath(StringRef ToolPath,
+  static std::string getLibPathByToolPath(BinaryContext &BC, // oteodoro:  added BC arg
+                                          StringRef ToolPath,
                                           StringRef LibFileName);
 
   /// Get the full path to a runtime library by the install directory.
@@ -68,7 +69,7 @@ protected:
 
   /// Gets the full path to a runtime library based on whether it exists
   /// in the install libdir or runtime libdir.
-  static std::string getLibPath(StringRef ToolPath, StringRef LibFileName);
+  static std::string getLibPath(BinaryContext &BC, StringRef ToolPath, StringRef LibFileName); // oteodoro:  added BC arg
 
   /// Load a static runtime library specified by \p LibPath.
   static void loadLibrary(StringRef LibPath, BOLTLinker &Linker,
--- a/bolt/lib/RuntimeLibs/HugifyRuntimeLibrary.cpp	2025-11-03 01:35:47.000000000 -0800
+++ b/bolt/lib/RuntimeLibs/HugifyRuntimeLibrary.cpp	2025-11-10 06:47:33.824996867 -0800
@@ -63,7 +63,7 @@ void HugifyRuntimeLibrary::link(BinaryCo
                                 BOLTLinker &Linker,
                                 BOLTLinker::SectionsMapper MapSections) {
 
-  std::string LibPath = getLibPath(ToolPath, opts::RuntimeHugifyLib);
+  std::string LibPath = getLibPath(BC, ToolPath, opts::RuntimeHugifyLib); // oteodoro:  added BC arg
   loadLibrary(LibPath, Linker, MapSections);
 
   assert(!RuntimeStartAddress &&
--- a/bolt/lib/RuntimeLibs/InstrumentationRuntimeLibrary.cpp	2025-11-03 01:35:47.000000000 -0800
+++ b/bolt/lib/RuntimeLibs/InstrumentationRuntimeLibrary.cpp	2025-11-10 06:47:33.825313878 -0800
@@ -197,7 +197,7 @@ void InstrumentationRuntimeLibrary::emit
 void InstrumentationRuntimeLibrary::link(
     BinaryContext &BC, StringRef ToolPath, BOLTLinker &Linker,
     BOLTLinker::SectionsMapper MapSections) {
-  std::string LibPath = getLibPath(ToolPath, opts::RuntimeInstrumentationLib);
+  std::string LibPath = getLibPath(BC, ToolPath, opts::RuntimeInstrumentationLib); // oteodoro:  added BC arg
   loadLibrary(LibPath, Linker, MapSections);
 
   if (BC.isMachO())
--- a/bolt/lib/RuntimeLibs/RuntimeLibrary.cpp	2025-11-03 01:35:47.000000000 -0800
+++ b/bolt/lib/RuntimeLibs/RuntimeLibrary.cpp	2025-11-10 06:51:59.883844389 -0800
@@ -13,6 +13,7 @@
 #include "bolt/RuntimeLibs/RuntimeLibrary.h"
 #include "bolt/Core/Linker.h"
 #include "bolt/RuntimeLibs/RuntimeLibraryVariables.inc"
+#include "bolt/Core/BinaryFunction.h"
 #include "bolt/Utils/Utils.h"
 #include "llvm/BinaryFormat/Magic.h"
 #include "llvm/Object/Archive.h"
@@ -27,16 +28,26 @@ using namespace bolt;
 
 void RuntimeLibrary::anchor() {}
 
-std::string RuntimeLibrary::getLibPathByToolPath(StringRef ToolPath,
+std::string RuntimeLibrary::getLibPathByToolPath(BinaryContext &BC,  // oteodoro:  added BC arg
+                                                 StringRef ToolPath,
                                                  StringRef LibFileName) {
   StringRef Dir = llvm::sys::path::parent_path(ToolPath);
   SmallString<128> LibPath = llvm::sys::path::parent_path(Dir);
-  llvm::sys::path::append(LibPath, "lib" LLVM_LIBDIR_SUFFIX);
+  std::string lib_dir("lib");                                                // oteodoro: start of added code block
+  if (BC.TheTriple->getArch() == llvm::Triple::aarch64) {                    // oteodoro:
+    lib_dir = "lib64";                                                       // oteodoro: Support multilib respecting lib conventions.
+  } else if (BC.TheTriple->getArch() == llvm::Triple::x86_64) {              // oteodoro:
+    lib_dir = "lib64";                                                       // oteodoro:
+  } else {                                                                   // oteodoro:
+    errs() << "BOLT-ERROR: Unsupported triple for this file\n";              // oteodoro:
+    exit(1);                                                                 // oteodoro:
+  }                                                                          // otedooro: end of added code block
+  llvm::sys::path::append(LibPath, lib_dir); // changed "lib" -> lib_dir
   if (!llvm::sys::fs::exists(LibPath)) {
     // In some cases we install bolt binary into one level deeper in bin/,
     // we need to go back one more level to find lib directory.
     LibPath = llvm::sys::path::parent_path(llvm::sys::path::parent_path(Dir));
-    llvm::sys::path::append(LibPath, "lib" LLVM_LIBDIR_SUFFIX);
+    llvm::sys::path::append(LibPath, lib_dir); // oteodoro:  changed "lib" -> lib_dir
   }
   llvm::sys::path::append(LibPath, LibFileName);
   if (!llvm::sys::fs::exists(LibPath)) {
@@ -65,13 +76,14 @@ std::string RuntimeLibrary::getLibPathBy
   return std::string(LibPath);
 }
 
-std::string RuntimeLibrary::getLibPath(StringRef ToolPath,
+std::string RuntimeLibrary::getLibPath(BinaryContext &BC,  // oteodoro:  added BC arg
+                                       StringRef ToolPath,
                                        StringRef LibFileName) {
   if (llvm::sys::fs::exists(LibFileName)) {
     return std::string(LibFileName);
   }
 
-  std::string ByTool = getLibPathByToolPath(ToolPath, LibFileName);
+  std::string ByTool = getLibPathByToolPath(BC, ToolPath, LibFileName);
   if (llvm::sys::fs::exists(ByTool)) {
     return ByTool;
   }
