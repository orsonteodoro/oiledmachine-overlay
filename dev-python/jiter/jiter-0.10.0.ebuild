# Copyright 2024-2025 Orson Teodoro <orsonteodoro@hotmail.com>
# Copyright 1999-2025 Gentoo Authors
# Distributed under the terms of the GNU General Public License v2

EAPI=8

DISTUTILS_EXT=1
DISTUTILS_USE_PEP517="maturin"
PYTHON_COMPAT=( "python3_"{10..12} )
RUST_MAX_VER="1.75.0" # Inclusive
RUST_MIN_VER="1.75.0" # llvm-17.0
RUST_PV="${RUST_MIN_VER}"

# Found in the crates folder
CRATES_EXCLUDED="
fuzz-0.10.0
jiter-python-0.10.0
"

# Generated by "./convert-cargo-lock.sh 0.10.0 0.10.0"
CRATES="
ahash-0.8.12
arbitrary-1.4.1
autocfg-1.5.0
bencher-0.1.5
bitflags-2.9.1
bitvec-1.0.1
bumpalo-3.19.0
cc-1.2.27
cfg-if-1.0.1
codspeed-2.10.1
codspeed-bencher-compat-2.10.1
colored-2.2.0
equivalent-1.0.2
funty-2.0.0
getrandom-0.3.3
hashbrown-0.15.4
heck-0.5.0
indexmap-2.10.0
indoc-2.0.6
itoa-1.0.15
jiter-0.10.0
jobserver-0.1.33
js-sys-0.3.77
lazy_static-1.5.0
lexical-parse-float-1.0.5
lexical-parse-integer-1.0.5
lexical-util-1.0.6
libc-0.2.174
libfuzzer-sys-0.4.9
log-0.4.27
memchr-2.7.5
memoffset-0.9.1
num-bigint-0.4.6
num-integer-0.1.46
num-traits-0.2.19
once_cell-1.21.3
paste-1.0.15
portable-atomic-1.11.1
proc-macro2-1.0.95
pyo3-0.25.1
pyo3-build-config-0.25.1
pyo3-ffi-0.25.1
pyo3-macros-0.25.1
pyo3-macros-backend-0.25.1
python3-dll-a-0.2.14
quote-1.0.40
r-efi-5.3.0
radium-0.7.0
rustversion-1.0.21
ryu-1.0.20
serde-1.0.219
serde_derive-1.0.219
serde_json-1.0.140
shlex-1.3.0
smallvec-1.15.1
static_assertions-1.1.0
syn-2.0.104
tap-1.0.1
target-lexicon-0.13.2
unicode-ident-1.0.18
unindent-0.2.4
uuid-1.17.0
version_check-0.9.5
wasi-0.14.2+wasi-0.2.4
wasm-bindgen-0.2.100
wasm-bindgen-backend-0.2.100
wasm-bindgen-macro-0.2.100
wasm-bindgen-macro-support-0.2.100
wasm-bindgen-shared-0.2.100
windows-sys-0.59.0
windows-targets-0.52.6
windows_aarch64_gnullvm-0.52.6
windows_aarch64_msvc-0.52.6
windows_i686_gnu-0.52.6
windows_i686_gnullvm-0.52.6
windows_i686_msvc-0.52.6
windows_x86_64_gnu-0.52.6
windows_x86_64_gnullvm-0.52.6
windows_x86_64_msvc-0.52.6
wit-bindgen-rt-0.39.0
wyz-0.5.1
zerocopy-0.8.26
zerocopy-derive-0.8.26
"

inherit distutils-r1 cargo edo

KEYWORDS="~amd64"
S="${WORKDIR}/${PN}-${PV}"
S_PROJECT="${WORKDIR}/${PN}-${PV}"
S_PYTHON="${WORKDIR}/${PN}-${PV}/crates/jiter-python"
SRC_URI="
$(cargo_crate_uris ${CRATES})
https://github.com/pydantic/jiter/archive/refs/tags/v${PV}.tar.gz
	-> ${P}.tar.gz
"

DESCRIPTION="Fast iterable JSON parser"
HOMEPAGE="
	https://github.com/pydantic/jiter
	https://pypi.org/project/jiter
"
LICENSE="
	MIT
"
RESTRICT="mirror"
SLOT="0/$(ver_cut 1-2 ${PV})"
IUSE+=" dev"
RDEPEND+="
	dev-python/orjson[${PYTHON_USEDEP}]
	dev-python/ujson[${PYTHON_USEDEP}]
"
DEPEND+="
	${RDEPEND}
"
BDEPEND+="
	dev-util/maturin[${PYTHON_USEDEP}]
"
DOCS=( "README.md" )

pkg_setup() {
	python_setup
	rust_pkg_setup
}

src_unpack() {
	unpack ${A}
	#die # For manual lockfile update
	cp -a \
		"${FILESDIR}/${PV}/Cargo."* \
		"${S}" \
		|| die
	cargo_src_unpack
}

src_prepare() {
	distutils-r1_src_prepare
}

python_configure() {
	:
}

src_configure() {
	cargo_src_configure
	distutils-r1_src_configure
}

python_compile() {
	cargo_src_compile
	pushd "${S_PYTHON}" >/dev/null 2>&1 || die
		edo maturin \
			pep517 \
			build-wheel \
			-i "${PYTHON}" \
			--compatibility off \
			--auditwheel=skip \
			--jobs=1 \
			--offline \
			--manifest-path "${S_PROJECT}/Cargo.toml"

		local d="${WORKDIR}/${PN}-${PV}-${EPYTHON/./_}/install"
		mkdir -p "${d}/usr/bin" || die
		local pyv="${EPYTHON/python/}"
		pyv="${pyv/./}"
		local wheel_path=$(realpath "${S_PROJECT}/target/wheels/${PN}-${PV}-cp${pyv}-cp${pyv}-linux_"*".whl")
		distutils_wheel_install "${d}" \
			"${wheel_path}"
	popd >/dev/null 2>&1 || die
}

src_compile() {
	distutils-r1_src_compile
}

src_install() {
	distutils-r1_src_install
	docinto "licenses"
	dodoc "LICENSE"
}

# OILEDMACHINE-OVERLAY-META:  CREATED-EBUILD
