# Copyright 2024-2025 Orson Teodoro <orsonteodoro@hotmail.com>
# Copyright 1999-2025 Gentoo Authors
# Distributed under the terms of the GNU General Public License v2

EAPI=8

# TODO package:
# chroma-hnswlib
# mypy-protobuf (low priority)
# opentelemetry-exporter-otlp-proto-grpc
# opentelemetry-instrumentation-fastapi
# posthog
# pypika

DISTUTILS_USE_PEP517="setuptools"
PYTHON_COMPAT=( "python3_"{10..12} )

# Generated by "./convert-cargo-lock.sh 0.6.3 0.6.3"
declare -A GIT_CRATES=(
[chromadb]="https://github.com/rescrv/chromadb-rs;7b46aab7366f009388f014929a92785c94134d61;" # 2.0.0
)

# Generated by "./convert-cargo-lock.sh 0.6.3 0.6.3"
CRATES="
addr2line-0.21.0
adler-1.0.2
adler2-2.0.0
ahash-0.8.11
aho-corasick-1.1.3
allocator-api2-0.2.18
android-tzdata-0.1.1
android_system_properties-0.1.5
anes-0.1.6
anstream-0.6.18
anstyle-1.0.10
anstyle-parse-0.2.6
anstyle-query-1.1.2
anstyle-wincon-3.0.6
anyhow-1.0.93
arc-swap-1.7.1
array-util-1.0.2
arrayvec-0.7.6
arrow-52.2.0
arrow-arith-52.2.0
arrow-array-52.2.0
arrow-buffer-52.2.0
arrow-cast-52.2.0
arrow-csv-52.2.0
arrow-data-52.2.0
arrow-ipc-52.2.0
arrow-json-52.2.0
arrow-ord-52.2.0
arrow-row-52.2.0
arrow-schema-52.2.0
arrow-select-52.2.0
arrow-string-52.2.0
assoc-0.1.3
async-channel-2.3.1
async-compression-0.4.18
async-stream-0.3.5
async-stream-impl-0.3.5
async-task-4.7.1
async-tempfile-0.6.0
async-trait-0.1.83
atoi-2.0.0
atomic-0.6.0
atomic-waker-1.1.2
auto_enums-0.8.6
autocfg-1.4.0
aws-config-1.5.4
aws-credential-types-1.2.1
aws-runtime-1.4.3
aws-sdk-s3-1.63.0
aws-sdk-sso-1.36.0
aws-sdk-ssooidc-1.37.0
aws-sdk-sts-1.36.0
aws-sigv4-1.2.5
aws-smithy-async-1.2.1
aws-smithy-checksums-0.60.13
aws-smithy-eventstream-0.60.5
aws-smithy-http-0.60.11
aws-smithy-json-0.60.7
aws-smithy-query-0.60.7
aws-smithy-runtime-1.7.3
aws-smithy-runtime-api-1.7.3
aws-smithy-types-1.2.9
aws-smithy-xml-0.60.9
aws-types-1.3.3
axum-0.7.9
axum-core-0.4.5
backoff-0.4.0
backtrace-0.3.71
base16ct-0.1.1
base64-0.21.7
base64-0.22.1
base64-simd-0.8.0
base64ct-1.6.0
bincode-1.3.3
bit-set-0.5.3
bit-vec-0.4.4
bit-vec-0.6.3
bitflags-1.3.2
bitflags-2.6.0
bitpacking-0.8.4
bitvec-1.0.1
block-buffer-0.10.4
bloom-0.3.2
bumpalo-3.15.4
bytemuck-1.20.0
byteorder-1.5.0
bytes-1.8.0
bytes-utils-0.1.4
bzip2-0.4.4
bzip2-sys-0.1.11+1.0.8
cast-0.3.0
cc-1.2.1
census-0.4.2
cfg-if-1.0.0
cfg_aliases-0.2.1
chrono-0.4.38
ciborium-0.2.2
ciborium-io-0.2.2
ciborium-ll-0.2.2
clap-4.5.21
clap_builder-4.5.21
clap_derive-4.5.18
clap_lex-0.7.3
cmsketch-0.2.1
colorchoice-1.0.3
concurrent-queue-2.5.0
console-0.15.8
const-oid-0.9.6
const-random-0.1.18
const-random-macro-0.1.16
core-foundation-0.10.0
core-foundation-0.9.4
core-foundation-sys-0.8.7
cpufeatures-0.2.16
crc32c-0.6.8
crc32fast-1.4.2
criterion-0.5.1
criterion-plot-0.5.0
crossbeam-channel-0.5.12
crossbeam-deque-0.8.5
crossbeam-epoch-0.9.18
crossbeam-utils-0.8.20
crunchy-0.2.2
crypto-bigint-0.4.9
crypto-bigint-0.5.5
crypto-common-0.1.6
csv-1.3.0
csv-core-0.1.11
ctor-0.1.26
darling-0.14.4
darling-0.20.10
darling_core-0.14.4
darling_core-0.20.10
darling_macro-0.14.4
darling_macro-0.20.10
der-0.6.1
deranged-0.3.11
derivative-2.2.0
derive_utils-0.14.2
digest-0.10.7
dirs-5.0.1
dirs-sys-0.4.1
displaydoc-0.2.5
downcast-rs-1.2.1
dyn-clone-1.0.17
ecdsa-0.14.8
either-1.13.0
elliptic-curve-0.12.3
encode_unicode-0.3.6
encoding_rs-0.8.35
equivalent-1.0.1
errno-0.3.9
event-listener-5.3.1
event-listener-strategy-0.5.2
fastdivide-0.4.1
fastrace-0.7.4
fastrace-macro-0.7.4
fastrace-opentelemetry-0.8.0
fastrand-2.2.0
ff-0.12.1
figment-0.10.19
fixedbitset-0.4.2
flatbuffers-24.3.25
flate2-1.0.35
flume-0.11.0
fnv-1.0.7
foldhash-0.1.3
foreign-types-0.3.2
foreign-types-shared-0.1.1
form_urlencoded-1.2.1
foyer-0.13.1
foyer-common-0.13.1
foyer-intrusive-collections-0.10.0-dev
foyer-memory-0.13.1
foyer-storage-0.13.1
fs4-0.12.0
fs4-0.6.6
funty-2.0.0
futures-0.3.31
futures-channel-0.3.31
futures-core-0.3.31
futures-executor-0.3.31
futures-io-0.3.31
futures-macro-0.3.31
futures-sink-0.3.31
futures-task-0.3.31
futures-util-0.3.31
generator-0.7.5
generator-0.8.1
generic-array-0.14.7
gethostname-0.2.3
getrandom-0.2.15
gimli-0.28.1
glob-0.3.1
group-0.12.1
guacamole-0.9.0
h2-0.3.26
h2-0.4.7
half-2.4.1
hashbrown-0.12.3
hashbrown-0.13.2
hashbrown-0.14.5
hashbrown-0.15.2
heck-0.4.1
heck-0.5.0
hermit-abi-0.3.9
hermit-abi-0.4.0
hex-0.4.3
hmac-0.12.1
home-0.5.9
htmlescape-0.3.1
http-0.2.12
http-1.1.0
http-body-0.4.6
http-body-1.0.1
http-body-util-0.1.2
http-range-header-0.3.1
httparse-1.9.5
httpdate-1.0.3
humantime-2.1.0
hyper-0.14.31
hyper-1.5.1
hyper-rustls-0.24.2
hyper-rustls-0.27.3
hyper-timeout-0.4.1
hyper-timeout-0.5.1
hyper-tls-0.5.0
hyper-tls-0.6.0
hyper-util-0.1.10
iana-time-zone-0.1.61
iana-time-zone-haiku-0.1.2
icu_collections-1.5.0
icu_locid-1.5.0
icu_locid_transform-1.5.0
icu_locid_transform_data-1.5.0
icu_normalizer-1.5.0
icu_normalizer_data-1.5.0
icu_properties-1.5.1
icu_properties_data-1.5.0
icu_provider-1.5.0
icu_provider_macros-1.5.0
ident_case-1.0.1
idna-1.0.3
idna_adapter-1.2.0
indexmap-1.9.3
indexmap-2.6.0
indicatif-0.17.9
inlinable_string-0.1.15
instant-0.1.13
ipnet-2.10.1
is-terminal-0.4.13
is_terminal_polyfill-1.70.1
itertools-0.10.5
itertools-0.11.0
itertools-0.13.0
itoa-1.0.14
jobserver-0.1.32
js-sys-0.3.69
json-patch-1.4.0
jsonpath-rust-0.3.5
k8s-openapi-0.20.0
kube-0.87.2
kube-client-0.87.2
kube-core-0.87.2
kube-derive-0.87.2
kube-runtime-0.87.2
lazy_static-1.5.0
levenshtein_automata-0.2.1
lexical-core-0.8.5
lexical-parse-float-0.8.5
lexical-parse-integer-0.8.6
lexical-util-0.8.5
lexical-write-float-0.8.5
lexical-write-integer-0.8.5
libc-0.2.165
libm-0.2.10
libredox-0.1.3
linux-raw-sys-0.4.14
litemap-0.7.4
lock_api-0.4.12
log-0.4.22
loom-0.5.6
lru-0.11.1
lru-0.12.4
lz4-1.26.0
lz4-sys-1.10.0
lz4_flex-0.11.3
madsim-0.2.30
madsim-macros-0.2.12
madsim-tokio-0.2.28
matchers-0.1.0
matchit-0.7.3
md-5-0.10.6
measure_time-0.8.3
memchr-2.7.4
memmap2-0.7.1
memoffset-0.9.1
mime-0.3.17
minimal-lexical-0.2.1
miniz_oxide-0.7.4
miniz_oxide-0.8.0
minreq-2.12.0
minstant-0.1.7
mio-1.0.2
multimap-0.8.3
murmur3-0.5.2
murmurhash32-0.3.1
naive-timer-0.2.0
nanorand-0.7.0
native-tls-0.2.12
network-interface-1.1.4
nom-7.1.3
nu-ansi-term-0.46.0
num-0.4.3
num-bigint-0.4.6
num-complex-0.4.6
num-conv-0.1.0
num-integer-0.1.46
num-iter-0.1.45
num-rational-0.4.2
num-traits-0.2.19
num_cpus-1.16.0
number_prefix-0.4.0
object-0.32.2
object_store-0.11.1
once_cell-1.20.2
oneshot-0.1.6
oorandom-11.1.3
openssl-0.10.66
openssl-macros-0.1.1
openssl-probe-0.1.5
openssl-sys-0.9.103
opentelemetry-0.27.0
opentelemetry-http-0.27.0
opentelemetry-otlp-0.27.0
opentelemetry-proto-0.27.0
opentelemetry_sdk-0.27.0
option-ext-0.2.0
ordered-float-2.10.1
ordered_hash_map-0.4.0
outref-0.5.1
overload-0.1.1
ownedbytes-0.6.0
owo-colors-3.5.0
p256-0.11.1
panic-message-0.3.0
parking-2.2.0
parking_lot-0.12.3
parking_lot_core-0.9.10
paste-1.0.15
pear-0.2.9
pear_codegen-0.2.9
pem-3.0.4
percent-encoding-2.3.1
pest-2.7.14
pest_derive-2.7.14
pest_generator-2.7.14
pest_meta-2.7.14
petgraph-0.6.4
pin-project-1.1.7
pin-project-internal-1.1.7
pin-project-lite-0.2.15
pin-utils-0.1.0
pkcs8-0.9.0
pkg-config-0.3.31
plotters-0.3.5
plotters-backend-0.3.5
plotters-svg-0.3.5
portable-atomic-1.9.0
powerfmt-0.2.0
ppv-lite86-0.2.20
prettyplease-0.2.16
proc-macro-error-attr2-2.0.0
proc-macro-error2-2.0.1
proc-macro2-1.0.92
proc-macro2-diagnostics-0.10.1
proptest-1.5.0
proptest-state-machine-0.3.0
prost-0.12.3
prost-0.13.3
prost-build-0.12.3
prost-derive-0.12.3
prost-derive-0.13.3
prost-types-0.12.3
quick-error-1.2.3
quick-xml-0.36.2
quinn-0.11.6
quinn-proto-0.11.9
quinn-udp-0.5.7
quote-1.0.37
radium-0.7.0
rand-0.8.5
rand_chacha-0.3.1
rand_core-0.6.4
rand_pcg-0.3.1
rand_xorshift-0.3.0
rand_xoshiro-0.6.0
random-port-0.1.1
rayon-1.10.0
rayon-core-1.12.1
redox_syscall-0.5.7
redox_users-0.4.6
regex-1.11.1
regex-automata-0.1.10
regex-automata-0.4.9
regex-lite-0.1.6
regex-syntax-0.6.29
regex-syntax-0.8.5
reqwest-0.11.27
reqwest-0.12.9
rfc6979-0.3.1
ring-0.17.8
roaring-0.10.6
rtrb-0.3.1
rust-stemmers-1.2.0
rustc-demangle-0.1.24
rustc-hash-1.1.0
rustc-hash-2.0.0
rustc_version-0.4.1
rustix-0.38.41
rustls-0.21.12
rustls-0.23.18
rustls-native-certs-0.6.3
rustls-native-certs-0.8.1
rustls-pemfile-1.0.4
rustls-pemfile-2.2.0
rustls-pki-types-1.10.0
rustls-webpki-0.101.7
rustls-webpki-0.102.8
rustversion-1.0.14
rusty-fork-0.3.0
ryu-1.0.18
same-file-1.0.6
scc-2.2.4
schannel-0.1.23
schemars-0.8.21
schemars_derive-0.8.21
scoped-tls-1.0.1
scopeguard-1.2.0
sct-0.7.1
sdd-3.0.4
sec1-0.3.0
secrecy-0.8.0
security-framework-2.11.1
security-framework-3.0.1
security-framework-sys-2.12.1
semver-1.0.23
serde-1.0.215
serde-value-0.7.0
serde_derive-1.0.215
serde_derive_internals-0.29.1
serde_json-1.0.133
serde_path_to_error-0.1.16
serde_spanned-0.6.7
serde_urlencoded-0.7.1
serde_yaml-0.9.34+deprecated
serial_test-3.2.0
serial_test_derive-3.2.0
sha1-0.10.6
sha2-0.10.8
sharded-slab-0.1.7
shlex-1.3.0
shuttle-0.7.1
signal-hook-registry-1.4.2
signature-1.6.4
siphasher-1.0.1
sketches-ddsketch-0.2.2
slab-0.4.9
smallvec-1.13.2
snafu-0.8.5
snafu-derive-0.8.5
socket2-0.5.7
spin-0.9.8
spki-0.6.0
stable_deref_trait-1.2.0
static_assertions-1.1.0
strsim-0.10.0
strsim-0.11.1
subtle-2.6.1
syn-1.0.109
syn-2.0.89
sync_wrapper-0.1.2
sync_wrapper-1.0.2
synstructure-0.13.1
system-configuration-0.5.1
system-configuration-0.6.1
system-configuration-sys-0.5.0
system-configuration-sys-0.6.0
tantivy-0.21.1
tantivy-bitpacker-0.5.0
tantivy-columnar-0.2.0
tantivy-common-0.6.0
tantivy-fst-0.4.0
tantivy-query-grammar-0.21.0
tantivy-sstable-0.2.0
tantivy-stacker-0.2.0
tantivy-tokenizer-api-0.2.0
tap-1.0.1
tempfile-3.14.0
thiserror-1.0.69
thiserror-2.0.4
thiserror-impl-1.0.69
thiserror-impl-2.0.4
thread_local-1.1.8
tikv-jemalloc-sys-0.6.0+5.3.0-1-ge13ca993e8ccb9ba9847cc330696e02839f328f7
tikv-jemallocator-0.6.0
time-0.3.36
time-core-0.1.2
time-macros-0.2.18
tiny-keccak-2.0.2
tinystr-0.7.6
tinytemplate-1.2.1
tinyvec-1.8.0
tinyvec_macros-0.1.1
tokio-1.41.1
tokio-io-timeout-1.2.0
tokio-macros-2.4.0
tokio-native-tls-0.3.1
tokio-rustls-0.24.1
tokio-rustls-0.26.0
tokio-stream-0.1.16
tokio-util-0.7.12
toml-0.8.19
toml_datetime-0.6.8
toml_edit-0.22.20
tonic-0.12.3
tonic-build-0.10.2
tower-0.4.13
tower-0.5.1
tower-http-0.4.4
tower-http-0.6.2
tower-layer-0.3.3
tower-service-0.3.3
tracing-0.1.40
tracing-attributes-0.1.27
tracing-bunyan-formatter-0.3.9
tracing-core-0.1.33
tracing-log-0.1.4
tracing-log-0.2.0
tracing-opentelemetry-0.28.0
tracing-subscriber-0.3.18
try-lock-0.2.5
twox-hash-2.0.1
typenum-1.17.0
ucd-trie-0.1.7
unarray-0.1.4
uncased-0.9.10
unicode-ident-1.0.14
unicode-width-0.1.14
unicode-width-0.2.0
unsafe-libyaml-0.2.11
untrusted-0.9.0
url-2.5.4
urlencoding-2.1.3
utf16_iter-1.0.5
utf8-ranges-1.0.5
utf8_iter-1.0.4
utf8parse-0.2.2
uuid-1.11.0
uuid-macro-internal-1.11.0
valuable-0.1.0
vcpkg-0.2.15
version_check-0.9.5
vsimd-0.8.0
wait-timeout-0.2.0
walkdir-2.5.0
want-0.3.1
wasi-0.11.0+wasi-snapshot-preview1
wasm-bindgen-0.2.92
wasm-bindgen-backend-0.2.92
wasm-bindgen-futures-0.4.42
wasm-bindgen-macro-0.2.92
wasm-bindgen-macro-support-0.2.92
wasm-bindgen-shared-0.2.92
wasm-streams-0.4.0
web-sys-0.3.69
web-time-1.1.0
webpki-roots-0.25.4
which-4.4.2
winapi-0.3.9
winapi-i686-pc-windows-gnu-0.4.0
winapi-util-0.1.8
winapi-x86_64-pc-windows-gnu-0.4.0
windows-0.48.0
windows-0.54.0
windows-core-0.52.0
windows-core-0.54.0
windows-registry-0.2.0
windows-result-0.1.1
windows-result-0.2.0
windows-strings-0.1.0
windows-sys-0.48.0
windows-sys-0.52.0
windows-sys-0.59.0
windows-targets-0.48.5
windows-targets-0.52.6
windows_aarch64_gnullvm-0.48.5
windows_aarch64_gnullvm-0.52.6
windows_aarch64_msvc-0.48.5
windows_aarch64_msvc-0.52.6
windows_i686_gnu-0.48.5
windows_i686_gnu-0.52.6
windows_i686_gnullvm-0.52.6
windows_i686_msvc-0.48.5
windows_i686_msvc-0.52.6
windows_x86_64_gnu-0.48.5
windows_x86_64_gnu-0.52.6
windows_x86_64_gnullvm-0.48.5
windows_x86_64_gnullvm-0.52.6
windows_x86_64_msvc-0.48.5
windows_x86_64_msvc-0.52.6
winnow-0.6.18
winreg-0.50.0
worker-0.1.0
write16-1.0.0
writeable-0.5.5
wyz-0.5.1
xmlparser-0.13.6
yansi-1.0.1
yoke-0.7.5
yoke-derive-0.7.5
zerocopy-0.7.35
zerocopy-derive-0.7.35
zerofrom-0.1.5
zerofrom-derive-0.1.5
zeroize-1.8.1
zerovec-0.10.4
zerovec-derive-0.10.3
zstd-0.12.4
zstd-0.13.0
zstd-safe-6.0.6
zstd-safe-7.0.0
zstd-sys-2.0.9+zstd.1.5.5
"

# Cargo must go after distutils-r1
inherit distutils-r1 cargo pypi

#KEYWORDS="~amd64" # Missing dependencies
S="${WORKDIR}/${PN}-${PV}"
SRC_URI="
$(cargo_crate_uris ${CRATES})
https://github.com/chroma-core/chroma/archive/refs/tags/${PV}.tar.gz
	-> ${P}.tar.gz
"

DESCRIPTION="the AI-native open-source embedding database"
HOMEPAGE="
	https://github.com/chroma-core/chroma
	https://pypi.org/project/chromadb
"
LICENSE="
	Apache-2.0
"
RESTRICT="mirror"
SLOT="0/$(ver_cut 1-2 ${PV})"
IUSE+=" dev"
RDEPEND+="
	$(python_gen_any_dep '
		>=sci-libs/tokenizers-0.13.2[${PYTHON_SINGLE_USEDEP}]
	')
	>=dev-python/bcrypt-4.0.1[${PYTHON_USEDEP}]
	>=dev-python/chroma-hnswlib-0.7.6[${PYTHON_USEDEP}]
	>=dev-python/fastapi-0.95.2[${PYTHON_USEDEP}]
	>=dev-python/grpcio-1.58.0[${PYTHON_USEDEP}]
	>=dev-python/httpx-0.27.0[${PYTHON_USEDEP}]
	>=dev-python/kubernetes-28.1.0[${PYTHON_USEDEP}]
	>=dev-python/mmh3-4.0.1[${PYTHON_USEDEP}]
	>=dev-python/numpy-1.22.5[${PYTHON_USEDEP}]
	>=dev-python/onnxruntime-1.14.1[${PYTHON_USEDEP}]
	>=dev-python/opentelemetry-api-1.24.0[${PYTHON_USEDEP}]
	>=dev-python/opentelemetry-exporter-otlp-proto-grpc-1.24.0[${PYTHON_USEDEP}]
	>=dev-python/opentelemetry-instrumentation-fastapi-0.41_beta0[${PYTHON_USEDEP}]
	>=dev-python/opentelemetry-sdk-1.24.0[${PYTHON_USEDEP}]
	>=dev-python/orjson-3.9.12[${PYTHON_USEDEP}]
	>=dev-python/overrides-7.3.1[${PYTHON_USEDEP}]
	>=dev-python/posthog-2.4.0[${PYTHON_USEDEP}]
	>=dev-python/pydantic-1.9[${PYTHON_USEDEP}]
	>=dev-python/pypika-0.48.9[${PYTHON_USEDEP}]
	>=dev-python/pyyaml-6.0.0[${PYTHON_USEDEP}]
	>=dev-python/rich-10.11.0[${PYTHON_USEDEP}]
	>=dev-python/tenacity-8.2.3[${PYTHON_USEDEP}]
	>=dev-python/tqdm-4.65.0[${PYTHON_USEDEP}]
	>=dev-python/typer-0.9.0[${PYTHON_USEDEP}]
	>=dev-python/typing-extensions-4.5.0[${PYTHON_USEDEP}]
	>=dev-python/uvicorn-0.18.3[${PYTHON_USEDEP},standard(+)]
	dev-python/importlib-resources[${PYTHON_USEDEP}]
"
DEPEND+="
	${RDEPEND}
"
BDEPEND+="
	>=dev-python/setuptools-61.0[${PYTHON_USEDEP}]
	>=dev-python/setuptools-scm-6.2[${PYTHON_USEDEP},toml(+)]
	dev? (
		>=dev-python/black-23.3.0[${PYTHON_USEDEP}]
		>=dev-python/grpcio-tools-1.67.1[${PYTHON_USEDEP}]
		>=dev-python/hypothesis-6.112.2[${PYTHON_USEDEP},numpy(+)]
		>=dev-python/protobuf-5.28.0[${PYTHON_USEDEP}]
		dev-python/build[${PYTHON_USEDEP}]
		dev-python/httpx[${PYTHON_USEDEP}]
		dev-python/mypy-protobuf[${PYTHON_USEDEP}]
		dev-python/psutil[${PYTHON_USEDEP}]
		dev-python/pytest[${PYTHON_USEDEP}]
		dev-python/pytest-asyncio[${PYTHON_USEDEP}]
		dev-python/pytest-xdist[${PYTHON_USEDEP}]
		dev-python/setuptools-scm[${PYTHON_USEDEP}]
		dev-python/types-protobuf[${PYTHON_USEDEP}]
		dev-vcs/pre-commit[${PYTHON_USEDEP}]
	)
"
DOCS=( "README.md" )

pkg_setup() {
	python_setup
	rust_pkg_setup
}

src_unpack() {
	unpack ${A}
	cargo_src_unpack
}

src_prepare() {
	distutils-r1_src_prepare
}

python_configure() {
	cargo_src_configure
}

src_configure() {
	distutils-r1_src_configure
}

python_compile() {
	cargo_src_compile
	distutils-r1_python_compile
}

src_compile() {
	distutils-r1_src_compile
}

src_install() {
	distutils-r1_src_install
	docinto "licenses"
	dodoc "LICENSE"
}

# OILEDMACHINE-OVERLAY-META:  CREATED-EBUILD
