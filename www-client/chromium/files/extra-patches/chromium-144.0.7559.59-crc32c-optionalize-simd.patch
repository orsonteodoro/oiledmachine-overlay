--- a/third_party/crc32c/BUILD.gn.orig	2026-01-06 16:50:30.000000000 -0800
+++ b/third_party/crc32c/BUILD.gn	2026-01-19 22:35:10.837643494 -0800
@@ -2,6 +2,7 @@
 # Use of this source code is governed by a BSD-style license that can be
 # found in the LICENSE file.
 
+import("//build/config/simd.gni")
 import("//testing/test.gni")
 
 # Only applied to CRC32C source and tests. (not exported)
@@ -22,10 +23,24 @@ config("crc32c_config") {
   # BYTE_ORDER_BIG_ENDIAN.
 
   if (current_cpu == "x86" || current_cpu == "x64") {
-    defines += [
-      "HAVE_MM_PREFETCH=1",
-      "HAVE_SSE42=1",
-    ]
+    if (use_sse) {
+      defines += [
+        "HAVE_MM_PREFETCH=1",
+      ]
+    } else {
+      defines += [
+        "HAVE_MM_PREFETCH=0",
+      ]
+    }
+    if (use_sse4_2) {
+      defines += [
+        "HAVE_SSE42=1",
+      ]
+    } else {
+      defines += [
+        "HAVE_SSE42=0",
+      ]
+    }
   } else {
     defines += [
       "HAVE_MM_PREFETCH=0",
@@ -33,13 +48,31 @@ config("crc32c_config") {
     ]
   }
   if (is_clang || !is_win) {
-    defines += [ "HAVE_BUILTIN_PREFETCH=1" ]
+    if (use_sse) {
+      defines += [ "HAVE_BUILTIN_PREFETCH=1" ]
+    } else if (use_edsp) {
+      defines += [ "HAVE_BUILTIN_PREFETCH=1" ]
+    } else if (current_cpu == "loong64") {
+      defines += [ "HAVE_BUILTIN_PREFETCH=1" ]
+    } else if (current_cpu == "mips" || current_cpu == "mips64" || current_cpu == "mipsel" || current_cpu == "mips64el") {
+      defines += [ "HAVE_BUILTIN_PREFETCH=1" ]
+    } else if (current_cpu == "ppc" || current_cpu == "ppc64") {
+      defines += [ "HAVE_BUILTIN_PREFETCH=1" ]
+    } else if (current_cpu == "s390" || current_cpu == "s390x") {
+      defines += [ "HAVE_BUILTIN_PREFETCH=1" ]
+    } else {
+      defines += [ "HAVE_BUILTIN_PREFETCH=0" ]
+    }
   } else {
     defines += [ "HAVE_BUILTIN_PREFETCH=0" ]
   }
 
   if (current_cpu == "arm64") {
-    defines += [ "HAVE_ARM64_CRC32C=1" ]
+    if (use_crc32) {
+      defines += [ "HAVE_ARM64_CRC32C=1" ]
+    } else {
+      defines += [ "HAVE_ARM64_CRC32C=0" ]
+    }
   } else {
     defines += [ "HAVE_ARM64_CRC32C=0" ]
   }
@@ -67,10 +100,18 @@ source_set("crc32c") {
 
   configs += [ ":crc32c_config" ]
   deps = [
-    ":crc32c_arm64",
     ":crc32c_internal_headers",
-    ":crc32c_sse42",
   ]
+  if (use_aes && use_crc32 && use_crypto) {
+    deps += [
+      ":crc32c_arm64",
+    ]
+  }
+  if (use_sse4_2) {
+    deps += [
+      ":crc32c_sse42",
+    ]
+  }
 }
 
 source_set("crc32c_sse42") {
@@ -160,9 +201,19 @@ test("crc32c_tests") {
   configs += [ ":crc32c_config" ]
   deps = [
     ":crc32c",
-    ":crc32c_arm64",
     ":crc32c_internal_headers",
-    ":crc32c_sse42",
+  ]
+  if (use_aes && use_crc32 && use_crypto) {
+    deps += [
+      ":crc32c_arm64",
+    ]
+  }
+  if (use_sse4_2) {
+    deps += [
+      ":crc32c_sse42",
+    ]
+  }
+  deps += [
     "//testing/gtest:gtest_main",
     "//third_party/googletest:gtest",
   ]
@@ -173,9 +224,19 @@ test("crc32c_benchmark") {
   configs += [ ":crc32c_config" ]
   deps = [
     ":crc32c",
-    ":crc32c_arm64",
     ":crc32c_internal_headers",
-    ":crc32c_sse42",
+  ]
+  if (use_aes && use_crc32 && use_crypto) {
+    deps += [
+      ":crc32c_arm64",
+    ]
+  }
+  if (use_sse4_2) {
+    deps += [
+      ":crc32c_sse42",
+    ]
+  }
+  deps += [
     "//third_party/google_benchmark",
   ]
 }
